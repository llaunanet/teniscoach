<!DOCTYPE html>
<html class="light" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Tennis Coach Pro</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <!-- Material Symbols -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#d84818",
                        "background-light": "#f8f6f6",
                        "background-dark": "#211511",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        body {
            font-family: 'Lexend', sans-serif;
            min-height: 100dvh;
        }

        .page-container {
            display: none;
        }

        .page-container.active {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .font-fill-1 {
            font-variation-settings: 'FILL' 1;
        }

        /* Desktop specific adjustments */
        @media (min-width: 768px) {
            .desktop-sidebar {
                display: flex !important;
            }

            .mobile-nav {
                display: none !important;
            }

            .main-wrapper {
                max-width: none !important;
                flex-direction: row !important;
                background-color: #f8f6f6;
            }

            .content-area {
                flex: 1;
                margin-left: 260px;
                padding: 2rem;
            }

            .fab-container {
                right: 3rem !important;
                bottom: 3rem !important;
            }

            .dashboard-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }
        }

        /* Weekly Calendar Styles */
        .calendar-week-header {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            border-bottom: 1px solid rgba(216, 72, 24, 0.1);
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .calendar-hour-col {
            width: 60px;
            border-right: 1px solid rgba(216, 72, 24, 0.05);
        }

        .calendar-grid-container {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            height: 1200px;
            /* 15 hours * 80px */
            position: relative;
        }

        .calendar-time-slot {
            height: 80px;
            border-bottom: 1px dashed rgba(216, 72, 24, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #97604e;
            font-weight: 600;
        }

        .calendar-day-col {
            border-right: 1px solid rgba(216, 72, 24, 0.05);
            position: relative;
        }

        .class-block {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 8px;
            padding: 6px;
            font-size: 10px;
            overflow: hidden;
            border-left: 3px solid #d84818;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            cursor: pointer;
            z-index: 5;
        }

        .class-block:hover {
            z-index: 20;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(216, 72, 24, 0.15);
        }

        .class-block.grupal {
            background: rgba(216, 72, 24, 0.1);
        }

        .class-block.privada {
            background: #fff;
            border: 1px solid rgba(216, 72, 24, 0.1);
            border-left: 3px solid #d84818;
        }

        /* Responsive fixes for the calendar grid */
        @media (max-width: 768px) {
            .class-block {
                left: 2px;
                right: 2px;
                padding: 2px;
                font-size: 8px;
            }

            .btn-delete-class {
                width: 14px;
                height: 14px;
                top: 1px;
                right: 1px;
            }

            .btn-delete-class span {
                font-size: 10px !important;
            }
        }


        .btn-delete-class {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #fff;
            color: #ef4444;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            z-index: 50;
            cursor: pointer;
            border: 1px solid #fee2e2;
        }

        .btn-delete-class:hover {
            background: #fee2e2;
            transform: scale(1.1);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#1b110e] antialiased">

    <!-- DESKTOP SIDEBAR -->
    <aside
        class="desktop-sidebar fixed left-0 top-0 bottom-0 w-[260px] bg-white border-r border-primary/5 hidden flex-col z-40">
        <div class="p-6 flex items-center gap-3">
            <div class="bg-primary p-2 rounded-xl">
                <span class="material-symbols-outlined text-white text-2xl">sports_tennis</span>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-[#1b110e]">Tennis Coach</h1>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-2">
            <a onclick="router.navigate('dashboard')"
                class="nav-item-desktop group flex items-center gap-3 px-4 py-3 rounded-xl transition-all cursor-pointer hover:bg-primary/5"
                data-page="dashboard">
                <span
                    class="material-symbols-outlined text-gray-400 group-[.active]:text-primary group-[.active]:font-fill-1">dashboard</span>
                <span class="font-semibold text-gray-500 group-[.active]:text-[#1b110e]">Dashboard</span>
            </a>
            <a onclick="router.navigate('calendar')"
                class="nav-item-desktop group flex items-center gap-3 px-4 py-3 rounded-xl transition-all cursor-pointer hover:bg-primary/5"
                data-page="calendar">
                <span
                    class="material-symbols-outlined text-gray-400 group-[.active]:text-primary group-[.active]:font-fill-1">calendar_month</span>
                <span class="font-semibold text-gray-500 group-[.active]:text-[#1b110e]">Calendario</span>
            </a>
            <a onclick="router.navigate('weekly-schedule')"
                class="nav-item-desktop group flex items-center gap-3 px-4 py-3 rounded-xl transition-all cursor-pointer hover:bg-primary/5"
                data-page="weekly-schedule">
                <span
                    class="material-symbols-outlined text-gray-400 group-[.active]:text-primary group-[.active]:font-fill-1">event_repeat</span>
                <span class="font-semibold text-gray-500 group-[.active]:text-[#1b110e]">Horario Fijo</span>
            </a>
            <a onclick="router.navigate('students')"
                class="nav-item-desktop group flex items-center gap-3 px-4 py-3 rounded-xl transition-all cursor-pointer hover:bg-primary/5"
                data-page="students">
                <span
                    class="material-symbols-outlined text-gray-400 group-[.active]:text-primary group-[.active]:font-fill-1">group</span>
                <span class="font-semibold text-gray-500 group-[.active]:text-[#1b110e]">Alumnos</span>
            </a>
            <a onclick="router.navigate('clubs')"
                class="nav-item-desktop group flex items-center gap-3 px-4 py-3 rounded-xl transition-all cursor-pointer hover:bg-primary/5"
                data-page="clubs">
                <span
                    class="material-symbols-outlined text-gray-400 group-[.active]:text-primary group-[.active]:font-fill-1">location_on</span>
                <span class="font-semibold text-gray-500 group-[.active]:text-[#1b110e]">Mis Clubs</span>
            </a>
            <a onclick="router.navigate('finance')"
                class="nav-item-desktop group flex items-center gap-3 px-4 py-3 rounded-xl transition-all cursor-pointer hover:bg-primary/5"
                data-page="finance">
                <span
                    class="material-symbols-outlined text-gray-400 group-[.active]:text-primary group-[.active]:font-fill-1">query_stats</span>
                <span class="font-semibold text-gray-500 group-[.active]:text-[#1b110e]">Estadísticas</span>
            </a>
            <a onclick="router.navigate('payments')"
                class="nav-item-desktop group flex items-center gap-3 px-4 py-3 rounded-xl transition-all cursor-pointer hover:bg-primary/5"
                data-page="payments">
                <span
                    class="material-symbols-outlined text-gray-400 group-[.active]:text-primary group-[.active]:font-fill-1">payments</span>
                <span class="font-semibold text-gray-500 group-[.active]:text-[#1b110e]">Gestión de Pagos</span>
            </a>
            <a onclick="router.navigate('extra-income')"
                class="nav-item-desktop group flex items-center gap-3 px-4 py-3 rounded-xl transition-all cursor-pointer hover:bg-primary/5"
                data-page="extra-income">
                <span
                    class="material-symbols-outlined text-gray-400 group-[.active]:text-primary group-[.active]:font-fill-1">receipt_long</span>
                <span class="font-semibold text-gray-500 group-[.active]:text-[#1b110e]">Otros Ingresos</span>
            </a>
        </nav>

        <div class="p-6 border-t border-primary/5">
            <div class="flex items-center gap-3 p-3 bg-primary/5 rounded-2xl">
                <div class="size-10 rounded-full border-2 border-primary/20 bg-cover bg-center shadow-sm"
                    style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBPVaCos61Ksfu45Qgm3prI2VSxM-x7MuC5_WiMeMOGTsvtWWKLOsfDimG6kzsIJ_BGNAJdltPZCeuMnW4v8hJxXYl50_6nYMX7p3T4ysHyODTZOu-FKYh2uS1xULQ8p0BDFjV5PUsRBVMga73mEzERIaLvkB-OEi8aOnrrgir-8q1FJnhW3TN8kXI4BlnQ8XIKW4E_zOjj_m3nkekwCP4QqJlJi8H-Q0nXTN5bC8itU2GdSLvsd_cGc7dCqQtBunVx_hgS6aw2o0xH");'>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-[#1b110e] truncate">Alain</p>
                    <p class="text-[10px] text-primary/70 font-bold uppercase tracking-wider">Coach Pro</p>
                </div>
            </div>
        </div>
    </aside>

    <div
        class="main-wrapper relative flex min-h-screen w-full flex-col max-w-md mx-auto md:max-w-none md:flex-row shadow-2xl md:shadow-none bg-white overflow-hidden transition-all duration-300">

        <!-- CONTENT AREA -->
        <main class="content-area flex flex-col flex-1 h-full overflow-hidden relative">

            <!-- DASHBOARD PAGE -->
            <div id="dashboard-page" class="page-container active">
                <header
                    class="flex items-center bg-background-light md:bg-transparent p-4 pb-2 justify-between shrink-0 md:mb-6">
                    <div class="md:hidden flex size-12 shrink-0 items-center">
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-primary/20"
                            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBPVaCos61Ksfu45Qgm3prI2VSxM-x7MuC5_WiMeMOGTsvtWWKLOsfDimG6kzsIJ_BGNAJdltPZCeuMnW4v8hJxXYl50_6nYMX7p3T4ysHyODTZOu-FKYh2uS1xULQ8p0BDFjV5PUsRBVMga73mEzERIaLvkB-OEi8aOnrrgir-8q1FJnhW3TN8kXI4BlnQ8XIKW4E_zOjj_m3nkekwCP4QqJlJi8H-Q0nXTN5bC8itU2GdSLvsd_cGc7dCqQtBunVx_hgS6aw2o0xH");'>
                        </div>
                    </div>
                    <div class="flex-1 md:flex-initial px-3 md:px-0">
                        <p class="text-primary/70 text-xs font-semibold uppercase tracking-wider md:hidden">Bienvenido
                        </p>
                        <h2 class="text-[#1b110e] text-xl md:text-3xl font-bold leading-tight tracking-[-0.015em]">
                            Dashboard</h2>
                    </div>
                    <div class="flex items-center gap-2">
                        <button
                            class="flex size-10 items-center justify-center rounded-full bg-primary/10 text-primary hover:bg-primary/20 transition-colors">
                            <span class="material-symbols-outlined text-xl">notifications</span>
                        </button>
                        <button
                            class="hidden md:flex bg-primary text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 hover:scale-105 transition-transform"
                            onclick="openAddClassModal()">
                            Programar Clase
                        </button>
                    </div>
                </header>
                <div class="flex-1 overflow-y-auto pb-24 md:pb-8 no-scrollbar">
                    <div class="dashboard-grid px-4 md:px-0">
                        <!-- Left Column / Hero -->
                        <div class="mb-6 md:mb-0">
                            <div
                                class="relative flex flex-col items-stretch justify-start rounded-2xl shadow-[0_4px_24px_rgba(216,72,24,0.08)] bg-white overflow-hidden border border-primary/5 h-full">
                                <div class="absolute top-0 right-0 w-48 h-48 bg-primary/5 rounded-full -mr-24 -mt-24">
                                </div>
                                <div
                                    class="flex w-full grow flex-col items-stretch justify-center gap-1 p-6 relative z-10">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span
                                            class="material-symbols-outlined text-primary text-sm font-fill-1">calendar_today</span>
                                        <p class="text-primary text-xs font-bold uppercase tracking-[0.15em]">Hoy</p>
                                    </div>
                                    <h1 id="today-classes-count"
                                        class="text-[#1b110e] text-3xl md:text-4xl font-extrabold leading-tight tracking-[-0.02em]">
                                        Cargando...
                                    </h1>
                                    <div id="next-class-preview" class="mt-6 flex flex-col gap-3">
                                        <!-- Next class will be dynamic -->
                                    </div>
                                </div>
                                <div class="w-full bg-center bg-no-repeat h-40 bg-cover opacity-90"
                                    style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDSm_mQh0sRy1kq8UgQyMiIa0uNiRCj0jpqwL8lqLgTVYpsyr0qTBg14H8H__WbWr7BBM_ftZ6glN-6KkMJd9ghDPLLTZlYbvs6dfAfKYYP-JztiP1vvA85SucWheMMmpDmmQA0w9ySf27tGimfRHzbeoAl9jkjKlE0OUPMUn2f_ZAi3OfLrOZ2XTZC3acpqhA9A9gJyxBzE7A_HtuJ4uWbT77kzLDRwW2U0WQho7vJYpLfN2GYPRvO8BSX7oAkHf4lnuDtu_HeXRLp");'>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column / Upcoming -->
                        <div>
                            <div class="flex items-center justify-between pb-4">
                                <h2 class="text-[#1b110e] text-lg font-bold leading-tight tracking-[-0.015em]">Próximas
                                    Clases</h2>
                                <button onclick="router.navigate('calendar')"
                                    class="text-primary text-sm font-bold flex items-center gap-1 hover:underline">
                                    Ver todo <span class="material-symbols-outlined text-sm">chevron_right</span>
                                </button>
                            </div>
                            <div id="upcoming-classes-list" class="flex flex-col gap-3">
                                <!-- Dynamic classes -->
                            </div>
                        </div>
                    </div>

                    <!-- Stats Section -->
                    <div class="stats-grid grid grid-cols-2 gap-4 p-4 md:px-0 md:pt-8">
                        <div
                            class="bg-white border border-primary/5 p-5 rounded-2xl shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-3 mb-2">
                                <span
                                    class="material-symbols-outlined text-primary bg-primary/10 p-2 rounded-lg text-xl">payments</span>
                                <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider">Ingresos
                                    Semanales</p>
                            </div>
                            <p id="weekly-income" class="text-[#1b110e] text-3xl font-extrabold">0.00€</p>
                        </div>
                        <div
                            class="bg-white border border-primary/5 p-5 rounded-2xl shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-3 mb-2">
                                <span
                                    class="material-symbols-outlined text-primary bg-primary/10 p-2 rounded-lg text-xl">schedule</span>
                                <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider">Horas Semanales
                                </p>
                            </div>
                            <p id="weekly-hours" class="text-[#1b110e] text-3xl font-extrabold">0h</p>
                        </div>
                        <div
                            class="bg-white border border-primary/5 p-5 rounded-2xl shadow-sm hover:shadow-md transition-shadow col-span-2 md:col-span-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span
                                    class="material-symbols-outlined text-primary bg-primary/10 p-2 rounded-lg text-xl">group</span>
                                <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider">Estudiantes</p>
                            </div>
                            <p id="total-students" class="text-[#1b110e] text-3xl font-extrabold">--</p>
                        </div>
                    </div>

                    <!-- Reminders Section -->
                    <div id="reminders-section" class="px-4 md:px-0 mt-8 mb-24 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-[#1b110e] text-lg font-bold leading-tight tracking-[-0.015em]">
                                Confirmaciones Pendientes</h2>
                            <button onclick="sendAllReminders()"
                                class="bg-primary/10 text-primary px-4 py-2 rounded-xl font-bold text-xs hover:bg-primary/20 transition-colors flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">send_all</span>
                                Enviar Todos
                            </button>
                        </div>
                        <div id="reminders-list" class="space-y-3">
                            <!-- Reminders will be dynamic -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- CALENDAR PAGE -->
            <div id="calendar-page" class="page-container">
                <header
                    class="flex items-center bg-white md:bg-transparent p-4 pb-2 justify-between border-b md:border-none border-gray-100 md:mb-4">
                    <div class="md:hidden text-primary flex size-10 shrink-0 items-center justify-center">
                        <span class="material-symbols-outlined text-3xl">sports_tennis</span>
                    </div>
                    <h2 id="calendar-title"
                        class="text-[#1b110e] text-lg md:text-3xl font-bold leading-tight tracking-[-0.015em] flex-1 md:text-left text-center">
                        Calendario</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="openImportScheduleModal()"
                            class="hidden md:flex bg-primary/10 text-primary px-4 py-2 rounded-xl font-bold text-xs hover:bg-primary/20 transition-all items-center gap-2">
                            <span class="material-symbols-outlined text-sm">auto_awesome</span>
                            Importar Horario
                        </button>
                        <button onclick="changeWeek(-1)"
                            class="p-2 hover:bg-primary/5 rounded-lg transition-colors"><span
                                class="material-symbols-outlined">chevron_left</span></button>
                        <button onclick="changeWeek(1)"
                            class="p-2 hover:bg-primary/5 rounded-lg transition-colors"><span
                                class="material-symbols-outlined">chevron_right</span></button>
                    </div>
                </header>

                <main
                    class="flex-1 overflow-hidden flex flex-col bg-white md:rounded-3xl shadow-sm border border-primary/5 mx-0 md:mx-0">
                    <!-- Days Header -->
                    <div id="calendar-week-header" class="calendar-week-header shrink-0">
                        <div class="calendar-hour-col"></div>
                        <!-- Days dynamically injected -->
                    </div>

                    <!-- Grid Body -->
                    <div class="flex-1 overflow-y-auto no-scrollbar relative bg-white" id="calendar-grid-body">
                        <div id="calendar-grid-content" class="calendar-grid-container">
                            <!-- Hours and Slots dynamically injected -->
                        </div>
                    </div>
                </main>
            </div>

            <!-- STUDENTS PAGE -->
            <div id="students-page" class="page-container">
                <header
                    class="bg-white md:bg-transparent px-4 py-4 md:px-0 border-b md:border-none border-primary/10 md:mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="bg-primary p-1.5 rounded-lg md:hidden">
                                <span class="material-symbols-outlined text-white text-2xl">sports_tennis</span>
                            </div>
                            <h1 class="text-xl md:text-3xl font-bold tracking-tight text-[#1b110e]">Mis Alumnos</h1>
                        </div>
                        <button
                            class="hidden md:flex bg-primary text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 hover:scale-105 transition-transform"
                            onclick="openModal('add-student-modal')">
                            Añadir Alumno
                        </button>
                    </div>
                    <div class="relative max-w-md">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-primary/60">search</span>
                        <input id="student-search"
                            class="w-full bg-white md:bg-white border md:border-primary/10 rounded-xl py-3 pl-10 pr-4 text-sm focus:ring-2 focus:ring-primary/20 placeholder:text-gray-400 shadow-sm"
                            placeholder="Buscar alumno..." type="text" />
                    </div>
                </header>
                <main id="students-list"
                    class="flex-1 overflow-y-auto px-4 py-4 md:px-0 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 bg-background-light md:bg-transparent pb-24 no-scrollbar">
                    <!-- Dynamic students -->
                </main>
            </div>

            <!-- CLUBS PAGE -->
            <div id="clubs-page" class="page-container">
                <header
                    class="bg-white md:bg-transparent px-4 py-4 md:px-0 border-b md:border-none border-primary/10 md:mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="bg-primary p-1.5 rounded-lg md:hidden">
                                <span class="material-symbols-outlined text-white text-2xl">location_on</span>
                            </div>
                            <h1 class="text-xl md:text-3xl font-bold tracking-tight text-[#1b110e]">Mis Clubs</h1>
                        </div>
                        <button
                            class="hidden md:flex bg-primary text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 hover:scale-105 transition-transform"
                            onclick="openModal('add-club-modal')">
                            Añadir Club
                        </button>
                    </div>
                    <div class="relative max-w-md">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-primary/60">search</span>
                        <input id="club-search"
                            class="w-full bg-white md:bg-white border md:border-primary/10 rounded-xl py-3 pl-10 pr-4 text-sm focus:ring-2 focus:ring-primary/20 placeholder:text-gray-400 shadow-sm"
                            placeholder="Buscar club..." type="text" />
                    </div>
                </header>
                <main id="clubs-list"
                    class="flex-1 overflow-y-auto px-4 py-4 md:px-0 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 bg-background-light md:bg-transparent pb-24 no-scrollbar">
                    <!-- Dynamic clubs -->
                </main>
            </div>

            <!-- FINANCE PAGE -->
            <div id="finance-page" class="page-container">
                <header
                    class="bg-white md:bg-transparent px-4 py-4 md:px-0 border-b md:border-none border-primary/10 md:mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="bg-primary p-1.5 rounded-lg md:hidden">
                                <span class="material-symbols-outlined text-white text-2xl">payments</span>
                            </div>
                            <h1 class="text-xl md:text-3xl font-bold tracking-tight text-[#1b110e]">Resumen de Ganancias
                            </h1>
                        </div>
                        <div class="flex bg-gray-100 p-1 rounded-xl">
                            <button id="mode-week" onclick="setFinanceMode('week')"
                                class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow-sm text-primary">Semana</button>
                            <button id="mode-month" onclick="setFinanceMode('month')"
                                class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-500">Mes</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-wider" id="finance-period-label">
                            Cargando periodo...</p>
                        <div class="flex items-center gap-2">
                            <button onclick="changeFinancePeriod(-1)" class="p-1 hover:bg-primary/5 rounded-lg"><span
                                    class="material-symbols-outlined text-sm">chevron_left</span></button>
                            <button onclick="changeFinancePeriod(1)" class="p-1 hover:bg-primary/5 rounded-lg"><span
                                    class="material-symbols-outlined text-sm">chevron_right</span></button>
                        </div>
                    </div>
                </header>
                <main class="flex-1 overflow-y-auto px-4 py-4 md:px-0 pb-24 no-scrollbar">
                    <!-- Finance Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white border border-primary/5 p-5 rounded-2xl shadow-sm">
                            <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider mb-1">Total Cobrado
                                (Volumen)
                            </p>
                            <p id="finance-total-paid" class="text-[#1b110e] text-3xl font-extrabold">0.00€</p>
                        </div>
                        <div class="bg-white border border-primary/5 p-5 rounded-2xl shadow-sm">
                            <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider mb-1">Pendiente</p>
                            <p id="finance-total-pending" class="text-primary text-3xl font-extrabold">0.00€</p>
                        </div>
                        <div class="bg-white border border-green-500/10 p-5 rounded-2xl shadow-sm bg-green-50/30">
                            <p class="text-green-600/70 text-[10px] font-bold uppercase tracking-wider mb-1">Mi
                                Beneficio Neto
                            </p>
                            <p id="finance-total-profit" class="text-green-600 text-3xl font-extrabold">0.00€</p>
                        </div>
                    </div>

                    <h2 class="text-[#1b110e] text-lg font-bold mb-4">Ganancias por Alumno</h2>
                    <div id="finance-student-list" class="space-y-3">
                        <!-- Dynamic list -->
                    </div>
                </main>
            </div>

            <!-- PAYMENTS MANAGEMENT PAGE -->
            <div id="payments-page" class="page-container">
                <header
                    class="flex items-center bg-background-light md:bg-transparent p-4 pb-2 justify-between shrink-0 md:mb-6">
                    <div class="flex-1 px-3 md:px-0">
                        <h2 class="text-[#1b110e] text-xl md:text-3xl font-bold leading-tight">Gestión de Pagos</h2>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="relative max-w-xs">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-primary/60 text-sm">filter_list</span>
                            <select id="payment-status-filter" onchange="loadPayments()"
                                class="bg-white border border-primary/10 rounded-xl py-2 pl-9 pr-4 text-[10px] font-bold uppercase tracking-wider appearance-none focus:ring-2 focus:ring-primary/20 shadow-sm">
                                <option value="all">Filtro: Todos</option>
                                <option value="pending">Solo Pendientes</option>
                                <option value="paid">Solo Pagados</option>
                            </select>
                        </div>
                        <div class="relative max-w-xs">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-primary/60 text-sm">sort</span>
                            <select id="payment-order-filter" onchange="loadPayments()"
                                class="bg-white border border-primary/10 rounded-xl py-2 pl-9 pr-4 text-[10px] font-bold uppercase tracking-wider appearance-none focus:ring-2 focus:ring-primary/20 shadow-sm">
                                <option value="desc">Más recientes primero</option>
                                <option value="asc">Más antiguos primero</option>
                            </select>
                        </div>
                    </div>
                </header>
                <main class="flex-1 overflow-y-auto px-4 py-4 md:px-0 pb-24 no-scrollbar">
                    <div id="payments-list" class="space-y-4">
                        <!-- Classes list for payment management -->
                    </div>
                </main>
            </div>

            <!-- WEEKLY SCHEDULE PAGE -->
            <div id="weekly-schedule-page" class="page-container">
                <header
                    class="bg-white md:bg-transparent px-4 py-4 md:px-0 border-b md:border-none border-primary/10 md:mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="bg-primary p-1.5 rounded-lg md:hidden">
                                <span class="material-symbols-outlined text-white text-2xl">event_repeat</span>
                            </div>
                            <h1 class="text-xl md:text-3xl font-bold tracking-tight text-[#1b110e]">Horario Semanal Fijo
                            </h1>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openDeleteFutureModal()"
                                class="bg-red-50 text-red-600 px-4 py-2 rounded-xl font-bold text-xs border border-red-100 hover:bg-red-100 transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">delete_sweep</span>
                                Borrar Futuras
                            </button>
                            <button onclick="propagateWeeklySchedule()"
                                class="bg-green-600 text-white px-4 py-2 rounded-xl font-bold text-xs shadow-lg shadow-green-200 hover:scale-105 transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">auto_mode</span>
                                Aplicar al Calendario
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">Define tu horario base que se repite todas las semanas del año.</p>
                </header>
                <main class="flex-1 overflow-y-auto px-4 py-4 md:px-0 pb-24 no-scrollbar">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Monday -->
                        <div class="bg-white rounded-2xl border border-primary/5 overflow-hidden shadow-sm">
                            <div
                                class="bg-gray-50 px-4 py-3 border-b border-primary/5 flex items-center justify-between">
                                <h3 class="font-black text-sm text-[#1b110e]">LUNES</h3>
                                <button onclick="openWeeklySlotModal(1)"
                                    class="text-primary p-1 hover:bg-primary/10 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-xl">add_circle</span>
                                </button>
                            </div>
                            <div id="weekly-slots-1" class="p-3 space-y-2 min-h-[100px]">
                                <!-- Dynamic slots -->
                            </div>
                        </div>
                        <!-- Tuesday -->
                        <div class="bg-white rounded-2xl border border-primary/5 overflow-hidden shadow-sm">
                            <div
                                class="bg-gray-50 px-4 py-3 border-b border-primary/5 flex items-center justify-between">
                                <h3 class="font-black text-sm text-[#1b110e]">MARTES</h3>
                                <button onclick="openWeeklySlotModal(2)"
                                    class="text-primary p-1 hover:bg-primary/10 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-xl">add_circle</span>
                                </button>
                            </div>
                            <div id="weekly-slots-2" class="p-3 space-y-2 min-h-[100px]">
                                <!-- Dynamic slots -->
                            </div>
                        </div>
                        <!-- Wednesday -->
                        <div class="bg-white rounded-2xl border border-primary/5 overflow-hidden shadow-sm">
                            <div
                                class="bg-gray-50 px-4 py-3 border-b border-primary/5 flex items-center justify-between">
                                <h3 class="font-black text-sm text-[#1b110e]">MIÉRCOLES</h3>
                                <button onclick="openWeeklySlotModal(3)"
                                    class="text-primary p-1 hover:bg-primary/10 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-xl">add_circle</span>
                                </button>
                            </div>
                            <div id="weekly-slots-3" class="p-3 space-y-2 min-h-[100px]">
                                <!-- Dynamic slots -->
                            </div>
                        </div>
                        <!-- Thursday -->
                        <div class="bg-white rounded-2xl border border-primary/5 overflow-hidden shadow-sm">
                            <div
                                class="bg-gray-50 px-4 py-3 border-b border-primary/5 flex items-center justify-between">
                                <h3 class="font-black text-sm text-[#1b110e]">JUEVES</h3>
                                <button onclick="openWeeklySlotModal(4)"
                                    class="text-primary p-1 hover:bg-primary/10 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-xl">add_circle</span>
                                </button>
                            </div>
                            <div id="weekly-slots-4" class="p-3 space-y-2 min-h-[100px]">
                                <!-- Dynamic slots -->
                            </div>
                        </div>
                        <!-- Friday -->
                        <div class="bg-white rounded-2xl border border-primary/5 overflow-hidden shadow-sm">
                            <div
                                class="bg-gray-50 px-4 py-3 border-b border-primary/5 flex items-center justify-between">
                                <h3 class="font-black text-sm text-[#1b110e]">VIERNES</h3>
                                <button onclick="openWeeklySlotModal(5)"
                                    class="text-primary p-1 hover:bg-primary/10 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-xl">add_circle</span>
                                </button>
                            </div>
                            <div id="weekly-slots-5" class="p-3 space-y-2 min-h-[100px]">
                                <!-- Dynamic slots -->
                            </div>
                        </div>
                        <!-- Saturday -->
                        <div class="bg-white rounded-2xl border border-primary/5 overflow-hidden shadow-sm">
                            <div
                                class="bg-gray-50 px-4 py-3 border-b border-primary/5 flex items-center justify-between">
                                <h3 class="font-black text-sm text-[#1b110e]">SÁBADO</h3>
                                <button onclick="openWeeklySlotModal(6)"
                                    class="text-primary p-1 hover:bg-primary/10 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-xl">add_circle</span>
                                </button>
                            </div>
                            <div id="weekly-slots-6" class="p-3 space-y-2 min-h-[100px]">
                                <!-- Dynamic slots -->
                            </div>
                        </div>
                        <!-- Sunday -->
                        <div class="bg-white rounded-2xl border border-primary/5 overflow-hidden shadow-sm">
                            <div
                                class="bg-gray-50 px-4 py-3 border-b border-primary/5 flex items-center justify-between">
                                <h3 class="font-black text-sm text-[#1b110e]">DOMINGO</h3>
                                <button onclick="openWeeklySlotModal(0)"
                                    class="text-primary p-1 hover:bg-primary/10 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-xl">add_circle</span>
                                </button>
                            </div>
                            <div id="weekly-slots-0" class="p-3 space-y-2 min-h-[100px]">
                                <!-- Dynamic slots -->
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- EXTRA INCOME PAGE -->
            <div id="extra-income-page" class="page-container">
                <header
                    class="flex items-center bg-background-light md:bg-transparent p-4 pb-2 justify-between shrink-0 md:mb-6">
                    <div class="flex-1 px-3 md:px-0">
                        <h2 class="text-[#1b110e] text-xl md:text-3xl font-bold leading-tight">Otros Ingresos</h2>
                    </div>
                    <button onclick="openAddExtraIncomeModal()"
                        class="hidden md:flex bg-primary text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 hover:scale-105 transition-transform">
                        Añadir Ingreso
                    </button>
                </header>
                <main class="flex-1 overflow-y-auto px-4 py-4 md:px-0 pb-24 no-scrollbar">
                    <div id="extra-income-list" class="space-y-4">
                        <!-- Dynamic extra income list -->
                    </div>
                </main>
            </div>

            <!-- Floating Action Button (Mobile) -->
            <div class="fab-container absolute bottom-24 right-6 z-20 md:hidden">
                <button id="add-btn"
                    class="flex h-14 w-14 items-center justify-center rounded-full bg-primary text-white shadow-lg shadow-primary/40 transition-transform active:scale-90 hover:scale-105">
                    <span class="material-symbols-outlined text-3xl">add</span>
                </button>
            </div>

            <!-- Bottom Navigation Bar (Mobile) -->
            <nav
                class="mobile-nav absolute bottom-0 left-0 right-0 z-30 flex gap-2 border-t border-primary/5 bg-white/95 backdrop-blur-md px-6 pb-6 pt-3 h-20 md:hidden">
                <a onclick="router.navigate('dashboard')"
                    class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-primary"
                    href="javascript:void(0)" data-page="dashboard">
                    <div class="flex h-6 items-center justify-center">
                        <span class="material-symbols-outlined"
                            style="font-variation-settings: 'FILL' 1">dashboard</span>
                    </div>
                    <p class="text-[10px] font-bold leading-normal tracking-wide">DASHBOARD</p>
                </a>
                <a onclick="router.navigate('calendar')"
                    class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-[#97604e]/60 hover:text-primary transition-colors"
                    href="javascript:void(0)" data-page="calendar">
                    <div class="flex h-6 items-center justify-center">
                        <span class="material-symbols-outlined">calendar_month</span>
                    </div>
                    <p class="text-[10px] font-bold leading-normal tracking-wide">CALENDARIO</p>
                </a>
                <a onclick="router.navigate('weekly-schedule')"
                    class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-[#97604e]/60 hover:text-primary transition-colors"
                    href="javascript:void(0)" data-page="weekly-schedule">
                    <div class="flex h-6 items-center justify-center">
                        <span class="material-symbols-outlined">event_repeat</span>
                    </div>
                    <p class="text-[10px] font-bold leading-normal tracking-wide">FIJO</p>
                </a>
                <a onclick="router.navigate('payments')"
                    class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-[#97604e]/60 hover:text-primary transition-colors"
                    href="javascript:void(0)" data-page="payments">
                    <div class="flex h-6 items-center justify-center">
                        <span class="material-symbols-outlined">payments</span>
                    </div>
                    <p class="text-[10px] font-bold leading-normal tracking-wide">PAGOS</p>
                </a>
                <a onclick="router.navigate('extra-income')"
                    class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-[#97604e]/60 hover:text-primary transition-colors"
                    href="javascript:void(0)" data-page="extra-income">
                    <div class="flex h-6 items-center justify-center">
                        <span class="material-symbols-outlined">receipt_long</span>
                    </div>
                    <p class="text-[10px] font-bold leading-normal tracking-wide">OTROS</p>
                </a>
                <a onclick="router.navigate('students')"
                    class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-[#97604e]/60 hover:text-primary transition-colors"
                    href="javascript:void(0)" data-page="students">
                    <div class="flex h-6 items-center justify-center">
                        <span class="material-symbols-outlined">group</span>
                    </div>
                    <p class="text-[10px] font-bold leading-normal tracking-wide">ALUMNOS</p>
                </a>
                <a onclick="router.navigate('finance')"
                    class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-[#97604e]/60 hover:text-primary transition-colors"
                    href="javascript:void(0)" data-page="finance">
                    <div class="flex h-6 items-center justify-center">
                        <span class="material-symbols-outlined">payments</span>
                    </div>
                    <p class="text-[10px] font-bold leading-normal tracking-wide">FINANZAS</p>
                </a>
            </nav>
        </main>
    </div>

    <!-- Modals -->
    <!-- Modal Añadir Alumno -->
    <div id="add-student-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4" id="student-modal-title">Añadir Alumno</h3>
            <input type="hidden" id="edit-student-id" />
            <div class="space-y-4">
                <input id="new-student-name" type="text" placeholder="Nombre completo"
                    class="w-full border-gray-200 rounded-xl px-4 py-3" />
                <input id="new-student-level" type="text" placeholder="Nivel (ej. Intermedio)"
                    class="w-full border-gray-200 rounded-xl px-4 py-3" />
                <input id="new-student-phone" type="tel" placeholder="Teléfono (ej. 34600000000)"
                    class="w-full border-gray-200 rounded-xl px-4 py-3" />
                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal('add-student-modal')"
                        class="flex-1 py-3 rounded-xl border border-gray-200 font-bold">Cancelar</button>
                    <button onclick="saveStudent()"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Añadir Clase -->
    <div id="add-class-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4" id="class-modal-title">Programar Clase</h3>
            <input type="hidden" id="edit-class-id" />
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Alumno</label>
                    <select id="class-student-id" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1"></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Fecha</label>
                    <input id="class-date" type="date" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1" />
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-400 uppercase">Inicio</label>
                        <input id="class-start" type="time" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1"
                            value="09:00" />
                    </div>
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-400 uppercase">Fin</label>
                        <input id="class-end" type="time" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1"
                            value="10:00" />
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Tipo</label>
                    <select id="class-type" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1">
                        <option value="Particular">Particular</option>
                        <option value="Grupal">Grupal</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Pista</label>
                    <input id="class-court" type="text" placeholder="Pista 1"
                        class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1" />
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Club</label>
                    <select id="class-club-id" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1"></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Precio (€)</label>
                    <input id="class-price" type="number" placeholder="0.00" step="0.5"
                        class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1" />
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal('add-class-modal')"
                        class="flex-1 py-3 rounded-xl border border-gray-200 font-bold">Cancelar</button>
                    <button onclick="saveClass()"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Añadir Club -->
    <div id="add-club-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4" id="club-modal-title">Añadir Club</h3>
            <input type="hidden" id="edit-club-id" />
            <div class="space-y-4">
                <input id="new-club-name" type="text" placeholder="Nombre del club"
                    class="w-full border-gray-200 rounded-xl px-4 py-3" />
                <input id="new-club-address" type="text" placeholder="Dirección"
                    class="w-full border-gray-200 rounded-xl px-4 py-3" />
                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal('add-club-modal')"
                        class="flex-1 py-3 rounded-xl border border-gray-200 font-bold">Cancelar</button>
                    <button onclick="saveClub()"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- IMPORT SCHEDULE MODAL -->
    <div id="import-schedule-modal"
        class="modal-overlay fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm px-0 md:px-4 hidden">
        <div
            class="modal-content w-full md:max-w-md bg-white rounded-t-[32px] md:rounded-[24px] overflow-hidden shadow-2xl animate-slide-up">
            <div class="p-6 md:p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-[#1b110e]">Importar desde Imagen</h3>
                    <button onclick="closeModal('import-schedule-modal')"
                        class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-gray-400">close</span>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- STEP 1: UPLOAD -->
                    <div id="import-step-1">
                        <div class="bg-blue-50 border border-blue-100 p-4 rounded-2xl flex gap-3 mb-6">
                            <span class="material-symbols-outlined text-blue-500">info</span>
                            <p class="text-xs text-blue-700 leading-relaxed font-medium">
                                Sube la imagen de tu horario semanal y selecciona qué día cae el <b>Lunes</b>. Analizaré
                                los
                                alumnos y horas automáticamente.
                            </p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">¿Qué
                                    fecha es este Lunes?</label>
                                <input id="import-monday-date"
                                    class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm font-bold text-[#1b110e] focus:ring-2 focus:ring-primary/20 transition-all appearance-none"
                                    type="date" />
                            </div>

                            <div
                                class="border-2 border-dashed border-gray-200 rounded-2xl p-8 flex flex-col items-center justify-center gap-3 bg-gray-50/50 hover:bg-gray-50 transition-colors cursor-pointer relative">
                                <input type="file" id="import-image-input"
                                    class="absolute inset-0 opacity-0 cursor-pointer" accept="image/jpeg,image/png"
                                    onchange="updateFileName(this)" />
                                <div class="bg-primary/10 p-4 rounded-full">
                                    <span
                                        class="material-symbols-outlined text-primary text-3xl">add_photo_alternate</span>
                                </div>
                                <p id="import-file-name" class="text-xs font-bold text-gray-400">Seleccionar horario
                                    (JPEG)</p>
                            </div>

                            <button onclick="processScheduleImage()"
                                class="w-full py-4 mt-2 rounded-xl bg-primary text-white font-bold text-sm shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined">psychology</span>
                                Procesar con IA
                            </button>
                        </div>
                    </div>

                    <!-- STEP 2: PREVIEW -->
                    <div id="import-step-2" class="hidden">
                        <div class="mb-4">
                            <h4 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                Clases detectadas (IA)
                            </h4>
                            <p class="text-[10px] text-gray-400 mt-1">He encontrado estas clases en la imagen. Se
                                aplicará un precio de 11€ a cada una.</p>
                        </div>

                        <div id="import-preview-list"
                            class="max-h-[300px] overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                            <!-- Clases populate here -->
                        </div>

                        <div class="grid grid-cols-2 gap-3 mt-6">
                            <button onclick="resetImportModal()"
                                class="py-3.5 rounded-xl border border-gray-100 font-bold text-sm text-gray-400 hover:bg-gray-50 transition-all">
                                Cancelar
                            </button>
                            <button id="import-confirm-btn" onclick="confirmImportSchedule()"
                                class="py-3.5 rounded-xl bg-green-600 text-white font-bold text-sm shadow-lg shadow-green-200 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined">check_circle</span>
                                Confirmar e Importar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>

    <!-- ADD EXTRA INCOME MODAL -->
    <div id="add-extra-income-modal"
        class="modal-overlay fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm px-0 md:px-4 hidden">
        <div
            class="modal-content w-full md:max-w-md bg-white rounded-t-[32px] md:rounded-[24px] overflow-hidden shadow-2xl animate-slide-up">
            <div class="p-6 md:p-8">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-2xl font-bold text-[#1b110e]">Otros Ingresos</h3>
                    <button onclick="closeModal('add-extra-income-modal')"
                        class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-gray-400">close</span>
                    </button>
                </div>

                <div class="space-y-5">
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Alumno</label>
                        <select id="extra-student-id" onchange="toggleManualName()"
                            class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 transition-all">
                            <option value="">-- Seleccionar Alumno --</option>
                            <option value="manual">Otro / Anotar a mano</option>
                        </select>
                    </div>

                    <div id="manual-name-container" class="hidden">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Nombre del
                            Alumno/Padre</label>
                        <input id="extra-manual-name"
                            class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 transition-all font-medium"
                            placeholder="Nombre completo" type="text" />
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Concepto</label>
                        <input id="extra-concept"
                            class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 transition-all font-medium"
                            placeholder="Ej: Torneo, Cordaje, Ropa..." type="text" />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Cantidad
                                (€)</label>
                            <input id="extra-amount"
                                class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 transition-all font-extrabold text-primary"
                                placeholder="0.00" type="number" step="0.01" />
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Fecha</label>
                            <input id="extra-date"
                                class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary/20 transition-all font-medium"
                                type="date" />
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button onclick="closeModal('add-extra-income-modal')"
                            class="flex-1 py-3 rounded-xl border border-gray-200 font-bold">Cancelar</button>
                        <button onclick="saveExtraIncome()"
                            class="flex-1 py-3 rounded-xl bg-primary text-white font-bold">Guardar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PROFIT MANAGEMENT MODAL -->
    <div id="profit-modal"
        class="modal-overlay fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm px-0 md:px-4 hidden">
        <div
            class="modal-content w-full md:max-w-sm bg-white rounded-t-[32px] md:rounded-[24px] overflow-hidden shadow-2xl animate-slide-up">
            <div class="p-6 md:p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-[#1b110e]">Anotar mi Ganancia</h3>
                    <button onclick="closeModal('profit-modal')"
                        class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-gray-400">close</span>
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="bg-primary/5 p-4 rounded-xl flex items-center justify-between">
                        <span class="text-xs font-bold text-primary uppercase tracking-wider">Importe Total</span>
                        <span id="profit-total-amount" class="text-lg font-extrabold text-[#1b110e]">0.00€</span>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Cuánto me
                            quedo yo (€)</label>
                        <input id="profit-kept-amount"
                            class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-lg font-extrabold text-green-600 focus:ring-2 focus:ring-green-500/20 transition-all"
                            placeholder="0.00" type="number" step="0.01" />
                        <p class="text-[10px] text-gray-400 mt-2">Puedes anotar el total o solo tu parte/comisión.</p>
                    </div>

                    <div class="flex flex-col gap-2 pt-2">
                        <button onclick="keepAll()"
                            class="w-full py-3 rounded-xl bg-green-500/10 text-green-600 font-bold text-sm hover:bg-green-500 hover:text-white transition-all">Quedarme
                            TODO</button>
                        <div class="flex gap-2">
                            <button onclick="closeModal('profit-modal')"
                                class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-sm">Cancelar</button>
                            <button onclick="saveProfit()"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold text-sm shadow-lg shadow-primary/20">Guardar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestionar Horario Fijo -->
    <div id="weekly-slot-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4" id="weekly-slot-modal-title">Añadir a Horario Fijo</h3>
            <input type="hidden" id="weekly-slot-id" />
            <input type="hidden" id="weekly-day-index" />
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Alumno</label>
                    <select id="weekly-student-id" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1"></select>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-400 uppercase">Inicio</label>
                        <input id="weekly-start" type="time" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1"
                            value="09:00" />
                    </div>
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-400 uppercase">Fin</label>
                        <input id="weekly-end" type="time" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1"
                            value="10:00" />
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Club</label>
                    <select id="weekly-club-id" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1"></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Tipo</label>
                    <select id="weekly-type" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1">
                        <option value="Particular">Particular (15€)</option>
                        <option value="Grupal">Grupal (11€)</option>
                    </select>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal('weekly-slot-modal')"
                        class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-sm">Cancelar</button>
                    <button onclick="saveWeeklySlot()"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold text-sm shadow-lg shadow-primary/20">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Propagar Horario -->
    <div id="propagate-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-2">Aplicar Horario</h3>
            <p class="text-xs text-gray-500 mb-6">Se generarán las clases en el calendario repitiendo tu horario semanal
                base.</p>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">¿A partir de qué fecha?</label>
                    <input id="propagate-start-date" type="date"
                        class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1" />
                </div>
                <div class="bg-amber-50 border border-amber-100 p-4 rounded-xl">
                    <p class="text-[10px] text-amber-700 font-medium">Esto creará clases hasta el final del año actual
                        (${new Date().getFullYear()}).</p>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal('propagate-modal')"
                        class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-sm">Cancelar</button>
                    <button id="propagate-confirm-btn" onclick="executePropagation()"
                        class="flex-1 py-3 rounded-xl bg-green-600 text-white font-bold text-sm shadow-lg shadow-green-200">Empezar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Borrar Clases Futuras -->
    <div id="delete-future-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-2">Borrar Clases Futuras</h3>
            <p class="text-xs text-gray-500 mb-6">Se eliminarán todas las clases del calendario a partir de la fecha
                seleccionada.</p>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">¿Desde qué fecha?</label>
                    <input id="delete-future-date" type="date"
                        class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1" />
                </div>
                <div class="bg-red-50 border border-red-100 p-4 rounded-xl">
                    <p class="text-[10px] text-red-700 font-medium">Atención: Esta acción eliminará permanentemente las
                        clases programadas (incluyendo las marcadas como pagadas) desde esa fecha en adelante.</p>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal('delete-future-modal')"
                        class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-sm">Cancelar</button>
                    <button id="delete-future-confirm-btn" onclick="executeDeleteFuture()"
                        class="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold text-sm shadow-lg shadow-red-200">Borrar
                        Clases</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Borrado Futuro de Slot Específico -->
    <div id="delete-future-slot-modal"
        class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-2">¿Borrar también del calendario?</h3>
            <p class="text-xs text-gray-500 mb-6">Has quitado este horario de tu plantilla semanal. ¿Quieres borrar
                también las clases ya programadas para este mismo día y hora?</p>

            <input type="hidden" id="del-slot-day" />
            <input type="hidden" id="del-slot-start" />
            <input type="hidden" id="del-slot-end" />

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">¿A partir de qué fecha borrar?</label>
                    <input id="del-slot-date" type="date" class="w-full border-gray-200 rounded-xl px-4 py-3 mt-1" />
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal('delete-future-slot-modal')"
                        class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-sm">No, solo
                        plantilla</button>
                    <button id="del-slot-confirm-btn" onclick="executeDeleteFutureSlot()"
                        class="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold text-sm shadow-lg shadow-red-200">Sí,
                        borrar clases</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://baiwqnfryhxacadgnzxn.supabase.co';
        const supabaseKey = 'sb_publishable_TTv6UG3ljM8o69h7IOEenw_LwTGbdeS';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // State Management
        const state = {
            alumnos: [],
            clases: [],
            clubes: [],
            currentPage: 'dashboard',
            currentWeekStart: new Date(),
            financeDate: new Date(),
            financeMode: 'week', // 'week' or 'month'
            weeklySlots: []
        };

        // Router
        const router = {
            navigate: (page) => {
                state.currentPage = page;
                document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
                document.getElementById(`${page}-page`).classList.add('active');

                // Update mobile nav styles
                document.querySelectorAll('.nav-item').forEach(item => {
                    const isSelected = item.dataset.page === page;
                    item.classList.toggle('text-primary', isSelected);
                    item.classList.toggle('text-[#97604e]/60', !isSelected);
                    const icon = item.querySelector('.material-symbols-outlined');
                    if (icon) icon.style.fontVariationSettings = isSelected ? "'FILL' 1" : "'FILL' 0";
                });

                // Update desktop sidebar styles
                document.querySelectorAll('.nav-item-desktop').forEach(item => {
                    const isSelected = item.dataset.page === page;
                    if (isSelected) {
                        item.classList.add('active', 'bg-primary/5');
                        item.classList.remove('text-gray-500');
                    } else {
                        item.classList.remove('active', 'bg-primary/5');
                    }
                });

                if (page === 'dashboard') loadDashboard();
                if (page === 'calendar') loadCalendar();
                if (page === 'students') loadStudents();
                if (page === 'clubs') loadClubs();
                if (page === 'finance') loadFinance();
                if (page === 'payments') loadPayments();
                if (page === 'extra-income') loadExtraIncome();
                if (page === 'weekly-schedule') loadWeeklySchedule();
            }
        };

        // Data Loading
        async function loadDashboard() {
            const today = new Date().toLocaleDateString('en-CA');

            // Get today's classes
            const { data: todayClasses } = await _supabase
                .from('clases')
                .select('*, alumnos(nombre, nivel, avatar_url), clubes(nombre)')
                .eq('fecha', today)
                .order('hora_inicio');

            document.getElementById('today-classes-count').innerText = `${todayClasses?.length || 0} clases hoy`;

            const nextClassPreview = document.getElementById('next-class-preview');
            if (todayClasses && todayClasses.length > 0) {
                const next = todayClasses[0];
                nextClassPreview.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-primary/10">
                            <span class="material-symbols-outlined text-primary">sports_tennis</span>
                        </div>
                        <div>
                            <p class="text-[#1b110e] text-sm font-semibold">${next.pista || 'Sin pista'} - ${next.clubes?.nombre || 'Club'}</p>
                            <p class="text-primary/80 text-xs font-medium">Próxima clase: ${next.alumnos.nombre} a las ${next.hora_inicio.substring(0, 5)}</p>
                        </div>
                    </div>
                `;
            } else {
                nextClassPreview.innerHTML = `<p class="text-gray-400 text-sm">No tienes clases para hoy</p>`;
            }

            // Upcoming list
            const { data: upcoming } = await _supabase
                .from('clases')
                .select('*, alumnos(nombre, nivel, avatar_url), clubes(nombre)')
                .gte('fecha', today)
                .order('fecha')
                .order('hora_inicio')
                .limit(5);

            const list = document.getElementById('upcoming-classes-list');
            list.innerHTML = upcoming?.map(cls => {
                const dateObj = new Date(cls.fecha);
                const isToday = cls.fecha === today;

                // Helper for tomorrow
                const tomorrowDate = new Date();
                tomorrowDate.setDate(new Date().getDate() + 1);
                const tomorrowStr = tomorrowDate.toLocaleDateString('en-CA');
                const isTomorrow = cls.fecha === tomorrowStr;

                let dateDisplay = "";
                if (isToday) dateDisplay = "Hoy";
                else if (isTomorrow) dateDisplay = "Mañana";
                else dateDisplay = dateObj.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });

                return `
                    <div class="flex items-center gap-4 bg-white p-4 rounded-xl border border-primary/5 shadow-sm">
                        <div class="relative">
                            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-14 border-2 border-primary/10" style='background-image: url("${cls.alumnos.avatar_url || 'https://images.unsplash.com/photo-1599566150163-29194dcaad36?w=100'}");'></div>
                        </div>
                        <div class="flex flex-col flex-1">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <p class="text-[#1b110e] text-base font-bold leading-normal">${cls.alumnos.nombre}</p>
                                    <span class="px-2 py-0.5 rounded bg-primary/10 text-primary text-[10px] font-bold uppercase tracking-tighter">${cls.alumnos.nivel || 'Nivel'}</span>
                                </div>
                                <span class="text-[10px] font-bold text-primary uppercase bg-primary/5 px-2 py-1 rounded-lg">${dateDisplay}</span>
                            </div>
                            <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider">${cls.clubes?.nombre || ''}</p>
                            <p class="text-primary/70 text-xs font-medium flex items-center justify-between gap-1 mt-0.5">
                                <span class="flex items-center gap-1"><span class="material-symbols-outlined text-xs">schedule</span> ${cls.hora_inicio.substring(0, 5)} - ${cls.hora_fin.substring(0, 5)}</span>
                                ${cls.precio ? `<span class="font-bold text-[#1b110e]">${cls.precio}€</span>` : ''}
                            </p>
                        </div>
                        <div class="shrink-0 flex items-center gap-2">
                            <div class="flex flex-col gap-1 items-end">
                                <button onclick="togglePaid('${cls.id}', ${cls.pagado})" class="flex items-center justify-center rounded-lg h-9 px-4 ${cls.pagado ? 'bg-green-500' : 'bg-primary'} text-white text-xs font-bold transition-all active:scale-95 shadow-md">
                                    ${cls.pagado ? 'Pagado' : 'Pendiente'}
                                </button>
                                <div class="flex gap-2 mt-1">
                                    <button onclick="openEditClassModal('${cls.id}')" class="text-[10px] font-bold text-blue-600 hover:underline transition-all">
                                        Editar
                                    </button>
                                    ${cls.pagado ? `
                                        <button onclick="openProfitModal('${cls.id}', 'clases', ${cls.precio || 0}, ${cls.ganancia_neta || 'null'})" class="text-[10px] font-bold ${cls.ganancia_neta !== null ? 'text-green-600' : 'text-primary underline'} transition-all">
                                            ${cls.ganancia_neta !== null ? 'Propio: ' + cls.ganancia_neta + '€' : '¿Mi parte?'}
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        ${cls.alumnos.telefono ? `
                            <button onclick="sendWhatsApp('${cls.alumnos.telefono}', 'Hola ${cls.alumnos.nombre}, te escribo para confirmar tu clase de tenis de hoy a las ${cls.hora_inicio.substring(0, 5)} en ${cls.clubes?.nombre || 'el club'}.')" 
                                class="flex items-center justify-center rounded-lg h-10 w-10 bg-green-500/10 text-green-600 hover:bg-green-500 hover:text-white transition-all shadow-sm">
                                <span class="material-symbols-outlined text-lg">message</span>
                            </button>
                        ` : ''}
                        </div>
                    </div>
                `;
            }).join('') || '';

            // Stats logic (Weekly)
            const weekStart = getStartOfWeek(new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            const { data: weekData } = await _supabase
                .from('clases')
                .select('precio, hora_inicio, hora_fin')
                .gte('fecha', weekStart.toLocaleDateString('en-CA'))
                .lte('fecha', weekEnd.toLocaleDateString('en-CA'));

            let totalIncome = 0;
            let totalHours = 0;

            if (weekData) {
                weekData.forEach(c => {
                    if (c.precio) totalIncome += parseFloat(c.precio);

                    const start = c.hora_inicio.split(':');
                    const end = c.hora_fin.split(':');
                    const duration = (parseInt(end[0]) + parseInt(end[1]) / 60) - (parseInt(start[0]) + parseInt(start[1]) / 60);
                    totalHours += duration;
                });
            }

            // Reminder System Logic
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('en-CA');

            const { data: reminderClasses } = await _supabase
                .from('clases')
                .select('*, alumnos(nombre, telefono), clubes(nombre)')
                .in('fecha', [today, tomorrowStr])
                .eq('recordatorio_enviado', false)
                .order('fecha')
                .order('hora_inicio');

            const remindersSection = document.getElementById('reminders-section');
            const remindersList = document.getElementById('reminders-list');

            // Force visibility check for debugging or if there are classes
            if (reminderClasses && reminderClasses.length > 0) {
                remindersSection.classList.remove('hidden');
                remindersList.innerHTML = reminderClasses.map(cls => {
                    const isTodayReminder = cls.fecha === today;
                    return `
                        <div class="bg-white border border-primary/5 p-4 rounded-2xl shadow-sm flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="bg-primary/5 p-2 rounded-lg">
                                    <span class="material-symbols-outlined text-primary text-xl">notifications_active</span>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-[#1b110e]">${cls.alumnos.nombre}</p>
                                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">
                                        ${isTodayReminder ? 'Hoy' : 'Mañana'} - ${cls.hora_inicio.substring(0, 5)}
                                    </p>
                                </div>
                            </div>
                            <button onclick="sendClassReminder('${cls.id}')" class="bg-green-500 text-white px-4 py-2 rounded-xl font-bold text-xs shadow-md shadow-green-500/10 active:scale-95 transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">send</span>
                                Recordar
                            </button>
                        </div>
                    `;
                }).join('');
            } else {
                remindersSection.classList.remove('hidden'); // Always show the section header
                remindersList.innerHTML = `
                    <div class="bg-gray-50 border border-dashed border-gray-200 p-6 rounded-2xl text-center">
                        <p class="text-gray-400 text-sm">No hay clases pendientes de confirmar para hoy o mañana.</p>
                    </div>
                `;
            }

            document.getElementById('weekly-income').innerText = totalIncome.toFixed(2) + '€';
            document.getElementById('weekly-hours').innerText = Math.round(totalHours) + 'h';

            const { count: studentCount } = await _supabase.from('alumnos').select('*', { count: 'exact', head: true });
            document.getElementById('total-students').innerText = studentCount;
        }

        async function loadPayments() {
            const filter = document.getElementById('payment-status-filter').value;
            const order = document.getElementById('payment-order-filter').value;
            const isAsc = order === 'asc';

            let query = _supabase
                .from('clases')
                .select('*, alumnos(nombre), clubes(nombre)')
                .order('fecha', { ascending: isAsc })
                .order('hora_inicio', { ascending: isAsc });

            if (filter === 'pending') query = query.eq('pagado', false);
            if (filter === 'paid') query = query.eq('pagado', true);

            const { data: classes } = await query;

            const list = document.getElementById('payments-list');

            if (!classes || classes.length === 0) {
                list.innerHTML = `<div class="bg-white p-8 rounded-2xl text-center border border-dashed border-gray-200">
                    <p class="text-gray-400">No hay clases registradas con este filtro.</p>
                </div>`;
                return;
            }

            list.innerHTML = classes.map(cls => {
                const dateObj = new Date(cls.fecha);
                return `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-primary/5 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-primary/5 flex flex-col items-center justify-center shrink-0">
                                <span class="text-[10px] font-bold text-primary uppercase">${dateObj.toLocaleDateString('es-ES', { month: 'short' })}</span>
                                <span class="text-lg font-bold text-[#1b110e] leading-none">${dateObj.getDate()}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-[#1b110e]">${cls.alumnos.nombre}</h3>
                                <div class="flex items-center gap-2 text-[10px] text-gray-400 font-bold uppercase tracking-wider">
                                    <span>${cls.hora_inicio.substring(0, 5)} - ${cls.hora_fin.substring(0, 5)}</span>
                                    <span>•</span>
                                    <span>${cls.clubes?.nombre || 'Sin club'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between md:justify-end gap-4 border-t md:border-t-0 pt-3 md:pt-0">
                            <div class="text-right">
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Cantidad</p>
                                <p class="text-lg font-extrabold text-[#1b110e]">${cls.precio || 0}€</p>
                            </div>
                            
                            <div class="flex flex-col gap-1.5 min-w-[120px]">
                                <div class="flex gap-1">
                                    <button onclick="togglePaid('${cls.id}', ${cls.pagado})" 
                                        class="flex-1 h-9 px-4 rounded-xl font-bold text-xs transition-all shadow-sm active:scale-95 ${cls.pagado ? 'bg-green-500 text-white shadow-green-500/20' : 'bg-primary/10 text-primary hover:bg-primary/20'}">
                                        ${cls.pagado ? 'Pagado' : 'Pendiente'}
                                    </button>
                                    <button onclick="openEditClassModal('${cls.id}')" class="w-9 h-9 flex items-center justify-center rounded-xl border border-blue-100 text-blue-600 hover:bg-blue-50 transition-all">
                                        <span class="material-symbols-outlined text-sm">edit</span>
                                    </button>
                                    <button onclick="deleteClass('${cls.id}')" class="w-9 h-9 flex items-center justify-center rounded-xl border border-red-100 text-red-600 hover:bg-red-50 transition-all">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                    </button>
                                </div>
                                
                                <button onclick="openProfitModal('${cls.id}', 'clases', ${cls.precio || 0}, ${cls.ganancia_neta || 'null'})" 
                                    class="h-9 px-4 rounded-xl font-bold text-[10px] transition-all border flex items-center justify-center gap-1.5 ${cls.ganancia_neta !== null ? 'bg-green-50 border-green-200 text-green-700' : 'bg-gray-50 border-gray-100 text-gray-400 hover:text-primary hover:bg-primary/5'}">
                                    <span class="material-symbols-outlined text-[16px]">${cls.ganancia_neta !== null ? 'task_alt' : 'wallet'}</span>
                                    ${cls.ganancia_neta !== null ? 'Propio: ' + cls.ganancia_neta + '€' : 'Me lo quedo'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadStudents(searchQuery = '') {
            let query = _supabase
                .from('alumnos')
                .select('*')
                .order('nombre');

            if (searchQuery) {
                query = query.ilike('nombre', `%${searchQuery}%`);
            }

            const { data: students } = await query;

            const list = document.getElementById('students-list');
            list.innerHTML = students?.map(s => `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full overflow-hidden bg-gray-200 border-2 border-primary/20">
                                <img class="w-full h-full object-cover" src="${s.avatar_url || 'https://images.unsplash.com/photo-1599566150163-29194dcaad36?w=100'}"/>
                            </div>
                            <div>
                                <h3 class="font-bold text-[#1b110e]">${s.nombre}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="bg-primary/10 text-primary text-[10px] font-bold px-2 py-0.5 rounded uppercase">${s.nivel || 'Nivel'}</span>
                                    <span class="text-xs text-gray-400">• ${s.estado || 'Active'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${s.telefono ? `
                                <button onclick="sendWhatsApp('${s.telefono}')" class="p-2 text-green-600 bg-green-500/10 rounded-lg hover:bg-green-500 hover:text-white transition-colors" title="WhatsApp">
                                    <span class="material-symbols-outlined text-xl">message</span>
                                </button>
                                <a href="tel:${s.telefono}" class="p-2 text-primary bg-primary/5 rounded-lg hover:bg-primary hover:text-white transition-colors" title="Llamar">
                                    <span class="material-symbols-outlined text-xl">call</span>
                                </a>
                            ` : ''}
                            <button onclick="openEditStudentModal('${s.id}')" class="p-2 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-600 hover:text-white transition-colors" title="Editar Alumno">
                                <span class="material-symbols-outlined text-xl">edit</span>
                            </button>
                            <button onclick="deleteStudent('${s.id}', '${s.nombre}')" class="p-2 text-red-600 bg-red-50 rounded-lg hover:bg-red-600 hover:text-white transition-colors" title="Eliminar Alumno">
                                <span class="material-symbols-outlined text-xl">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p class="text-center py-8 text-gray-400 col-span-full">No se encontraron alumnos</p>';
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function changeWeek(direction) {
            state.currentWeekStart.setDate(state.currentWeekStart.getDate() + (direction * 7));
            loadCalendar();
        }

        async function loadCalendar() {
            const weekStart = getStartOfWeek(state.currentWeekStart);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            const startStr = weekStart.toLocaleDateString('en-CA');
            const endStr = weekEnd.toLocaleDateString('en-CA');

            // Update Header
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            document.getElementById('calendar-title').innerText = `Semana ${weekStart.getDate()} ${months[weekStart.getMonth()]} - ${weekEnd.getDate()} ${months[weekEnd.getMonth()]}`;

            const header = document.getElementById('calendar-week-header');
            const days = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
            header.innerHTML = '<div class="calendar-hour-col"></div>' + days.map((day, i) => {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                const isToday = d.toISOString().split('T')[0] === new Date().toISOString().split('T')[0];
                return `
                    <div class="flex flex-col items-center py-2 ${isToday ? 'bg-primary/5' : ''}">
                        <span class="text-[10px] font-bold text-gray-400">${day}</span>
                        <span class="text-xs font-bold ${isToday ? 'text-primary' : 'text-[#1b110e]'}">${d.getDate()}</span>
                    </div>
                `;
            }).join('');

            // Setup Grid Content
            const gridContent = document.getElementById('calendar-grid-content');
            gridContent.innerHTML = '';

            // Hour slots (8 AM to 10 PM to match user's common view)
            const startHour = 8;
            const endHour = 22;
            const slotHeight = 80;

            // Render Hours and Background Slots with explicit grid rows
            let slotsHtml = '';
            for (let h = startHour; h <= endHour; h++) {
                const rowIndex = h - startHour + 1;
                slotsHtml += `<div class="calendar-time-slot" style="grid-row: ${rowIndex}">${h}:00</div>`;
                for (let d = 0; d < 7; d++) {
                    const colIndex = d + 2;
                    slotsHtml += `<div class="calendar-day-col" id="col-${d}-hour-${h}" style="grid-row: ${rowIndex}; grid-column: ${colIndex}"></div>`;
                }
            }
            gridContent.innerHTML = slotsHtml;

            // Fetch classes for this week
            const { data: weekClasses } = await _supabase
                .from('clases')
                .select('*, alumnos(nombre, nivel, telefono), clubes(nombre)')
                .gte('fecha', startStr)
                .lte('fecha', endStr);

            // Render individual class blocks
            if (weekClasses) {
                weekClasses.forEach(cls => {
                    // Correct date parsing for local timezone
                    const [y, m, dayOfMonth] = cls.fecha.split('-').map(Number);
                    const clsDate = new Date(y, m - 1, dayOfMonth);

                    // Adjust dayIndex (0 = Monday, 1 = Tuesday...)
                    let dayIndex = clsDate.getDay() - 1;
                    if (dayIndex === -1) dayIndex = 6;

                    const startParts = cls.hora_inicio.split(':');
                    const endParts = cls.hora_fin.split(':');

                    const startH = parseInt(startParts[0]);
                    const startM = parseInt(startParts[1]);
                    const endH = parseInt(endParts[0]);
                    const endM = parseInt(endParts[1]);

                    // Only render if within our display range
                    if (startH < startHour || startH > endHour) return;

                    const duration = (endH + endM / 60) - (startH + startM / 60);
                    const height = duration * slotHeight;
                    const topOffset = (startM / 60) * slotHeight;

                    const block = document.createElement('div');
                    block.className = `class-block ${cls.tipo.toLowerCase()} ${cls.pagado ? 'opacity-80' : ''}`;

                    // topOffset handles minutes (e.g. 14:30) within the hour cell
                    block.style.top = `${topOffset}px`;
                    block.style.height = `${height}px`;
                    block.style.zIndex = "20";

                    block.innerHTML = `
                        <div class="absolute top-1 right-1 flex gap-1">
                            <button class="w-6 h-6 flex items-center justify-center rounded-full bg-white/80 text-blue-600 shadow-sm hover:bg-white transition-all" onclick="event.stopPropagation(); openEditClassModal('${cls.id}')" title="Editar clase">
                                <span class="material-symbols-outlined text-[14px]">edit</span>
                            </button>
                            <button class="w-6 h-6 flex items-center justify-center rounded-full bg-white/80 text-red-600 shadow-sm hover:bg-white transition-all" onclick="event.stopPropagation(); deleteClass('${cls.id}')" title="Cancelar clase">
                                <span class="material-symbols-outlined text-[14px]">close</span>
                            </button>
                        </div>
                        <div class="font-bold truncate pr-6">${cls.alumnos.nombre}</div>
                        <div class="opacity-70 truncate text-[10px]">${cls.hora_inicio.substring(0, 5)} - ${cls.clubes?.nombre || ''}</div>
                        <div class="font-bold mt-1 text-primary">${cls.precio ? cls.precio + '€' : ''}</div>
                        <div class="absolute bottom-2 right-2 flex gap-1">
                            ${cls.alumnos.telefono ? `<span onclick="event.stopPropagation(); sendWhatsApp('${cls.alumnos.telefono}')" class="material-symbols-outlined text-[14px] text-green-600 cursor-pointer hover:scale-125 transition-transform" title="Enviar WhatsApp">message</span>` : ''}
                            <span onclick="event.stopPropagation(); togglePaid('${cls.id}', ${cls.pagado})" 
                                  class="material-symbols-outlined text-[14px] ${cls.pagado ? 'text-green-600 font-fill-1' : 'text-gray-300 hover:text-green-400'} cursor-pointer transition-all hover:scale-125" 
                                  title="${cls.pagado ? 'Marcar como pendiente' : 'Marcar como pagado'}">
                                check_circle
                            </span>
                        </div>
                    `;

                    const cellId = `col-${dayIndex}-hour-${startH}`;
                    const cell = document.getElementById(cellId);
                    if (cell) {
                        cell.appendChild(block);
                    }

                });
            }


            // Auto scroll to current time if viewing current week
            const isCurrentWeek = new Date() >= weekStart && new Date() <= weekEnd;
            if (isCurrentWeek) {
                const now = new Date();
                const currentHour = now.getHours();
                if (currentHour >= startHour && currentHour <= endHour) {
                    const scrollPos = (currentHour - startHour) * slotHeight - 100;
                    document.getElementById('calendar-grid-body').scrollTop = scrollPos;
                }
            }
        }

        async function openImportScheduleModal() {
            document.getElementById('import-monday-date').value = getStartOfWeek(new Date()).toLocaleDateString('en-CA');
            document.getElementById('import-file-name').innerText = 'Seleccionar horario (JPEG)';
            openModal('import-schedule-modal');
        }

        function updateFileName(input) {
            const fileName = input.files[0]?.name || 'Seleccionar horario (JPEG)';
            document.getElementById('import-file-name').innerText = fileName;
        }

        let detectedClasses = []; // Temporary storage for classes extracted by IA

        async function processScheduleImage() {
            const date = document.getElementById('import-monday-date').value;
            const file = document.getElementById('import-image-input').files[0];

            if (!date || !file) {
                alert('Por favor, selecciona la fecha del Lunes y sube la imagen.');
                return;
            }

            // Simulating AI analysis based on the image provided earlier
            // In a real app, this would send the image to a backend/OCR
            const monday = new Date(date);
            const alumnos = await _supabase.from('alumnos').select('id, nombre');

            // Raw data filtered for ALAN only as requested
            const rawData = [
                { name: 'ALAN', day: 0, start: '18:00', end: '19:00', type: 'Individual', color: 'bg-blue-100 text-blue-700' },
                { name: 'ALAN', day: 1, start: '17:00', end: '18:30', type: 'Individual', color: 'bg-blue-100 text-blue-700' },
                { name: 'ALAN', day: 2, start: '19:00', end: '20:00', type: 'Individual', color: 'bg-blue-100 text-blue-700' },
                { name: 'ALAN', day: 3, start: '17:00', end: '18:30', type: 'Individual', color: 'bg-blue-100 text-blue-700' },
                { name: 'ALAN', day: 4, start: '17:30', end: '19:00', type: 'Individual', color: 'bg-blue-100 text-blue-700' },
                { name: 'ALAN', day: 5, start: '12:00', end: '13:30', type: 'Individual', color: 'bg-blue-100 text-blue-700' }
            ];

            const STUDENT_POR_DEFINIR_ID = 'e0466acc-f413-4d73-b551-c6eeea894d37';
            const CLUB_TERRAMELAR_ID = 'e927e3a9-9d6a-467a-8527-e497a82074c7';

            detectedClasses = rawData.map(item => {
                const classDate = new Date(monday);
                classDate.setDate(monday.getDate() + item.day);
                return {
                    alumno_id: STUDENT_POR_DEFINIR_ID,
                    club_id: CLUB_TERRAMELAR_ID,
                    temp_name: item.name,
                    fecha: classDate.toLocaleDateString('en-CA'),
                    hora_inicio: item.start,
                    hora_fin: item.end,
                    tipo: item.type,
                    pista: '2',
                    precio: 11,
                    color: item.color
                };
            });

            // Update UI to Step 2
            const previewList = document.getElementById('import-preview-list');
            previewList.innerHTML = detectedClasses.map(c => `
                <div class="flex items-center justify-between p-3 rounded-xl border border-gray-100 bg-gray-50/50">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 rounded-md text-[9px] font-bold uppercase ${c.color}">${c.temp_name}</span>
                            <span class="text-xs font-bold text-[#1b110e]">${new Date(c.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' })}</span>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-0.5">${c.hora_inicio} - ${c.hora_fin} • ${c.tipo}</div>
                    </div>
                    <div class="text-xs font-black text-gray-800">11,00€</div>
                </div>
            `).join('');

            document.getElementById('import-step-1').classList.add('hidden');
            document.getElementById('import-step-2').classList.remove('hidden');
        }

        function resetImportModal() {
            document.getElementById('import-step-1').classList.remove('hidden');
            document.getElementById('import-step-2').classList.add('hidden');
            document.getElementById('import-image-input').value = '';
            document.getElementById('import-file-name').innerText = 'Seleccionar horario (JPEG)';
        }

        async function confirmImportSchedule() {
            const btn = document.getElementById('import-confirm-btn');
            btn.innerHTML = '<span class="animate-spin material-symbols-outlined">sync</span> Importando...';
            btn.disabled = true;

            // Filter out classes without actual student IDs (if you haven't created them yet)
            const validClasses = detectedClasses.filter(c => c.alumno_id !== null).map(({ temp_name, color, ...rest }) => rest);

            if (validClasses.length === 0) {
                alert('No se han encontrado alumnos que coincidan en tu base de datos (Antonio, Chema...). Por favor, créalos primero o renombra los actuales.');
                btn.innerHTML = 'Confirmar e Importar';
                btn.disabled = false;
                return;
            }

            const { error } = await _supabase.from('clases').insert(validClasses);

            if (error) {
                alert('Error al importar: ' + error.message);
            } else {
                alert('¡Horario importado con éxito!');
                closeModal('import-schedule-modal');
                resetImportModal();
                loadCalendar();
                loadDashboard();
            }
        }

        async function saveImportedSchedule(classes) {
            // This will be called by the AI after analyzing the image
            const { error } = await _supabase.from('clases').insert(classes);
            if (error) {
                alert('Error al importar las clases: ' + error.message);
            } else {
                alert('¡Horario importado con éxito!');
                loadCalendar();
                loadDashboard();
            }
        }

        async function loadFinance() {
            let start, end;
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const monthsShort = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            if (state.financeMode === 'week') {
                start = getStartOfWeek(state.financeDate);
                end = new Date(start);
                end.setDate(start.getDate() + 6);
                document.getElementById('finance-period-label').innerText = `Semana ${start.getDate()} ${monthsShort[start.getMonth()]} - ${end.getDate()} ${monthsShort[end.getMonth()]}`;
            } else {
                start = new Date(state.financeDate.getFullYear(), state.financeDate.getMonth(), 1);
                end = new Date(state.financeDate.getFullYear(), state.financeDate.getMonth() + 1, 0);
                document.getElementById('finance-period-label').innerText = `${months[start.getMonth()]} ${start.getFullYear()}`;
            }

            const startStr = start.toLocaleDateString('en-CA');
            const endStr = end.toLocaleDateString('en-CA');

            // Get classes
            const { data: financeData } = await _supabase
                .from('clases')
                .select('*, alumnos(nombre, avatar_url)')
                .gte('fecha', startStr)
                .lte('fecha', endStr);

            // Get extra income
            const { data: extraIncomeData } = await _supabase
                .from('ingresos_extras')
                .select('*, alumnos(nombre, avatar_url)')
                .gte('fecha', startStr)
                .lte('fecha', endStr);

            let totalPaid = 0;
            let totalPending = 0;
            const studentEarns = {};

            if (financeData) {
                financeData.forEach(c => {
                    const amount = parseFloat(c.precio || 0);
                    if (c.pagado) totalPaid += amount;
                    else totalPending += amount;

                    const studentName = c.alumnos?.nombre || 'Desconocido';
                    if (!studentEarns[studentName]) {
                        studentEarns[studentName] = { paid: 0, pending: 0, avatar: c.alumnos?.avatar_url };
                    }
                    if (c.pagado) studentEarns[studentName].paid += amount;
                    else studentEarns[studentName].pending += amount;
                });
            }

            // Add extra income (always considered "paid")
            if (extraIncomeData) {
                extraIncomeData.forEach(e => {
                    const amount = parseFloat(e.cantidad || 0);
                    totalPaid += amount;

                    const studentName = e.alumnos?.nombre || e.nombre_manual || 'Otros / Varios';
                    if (!studentEarns[studentName]) {
                        studentEarns[studentName] = { paid: 0, pending: 0, avatar: e.alumnos?.avatar_url };
                    }
                    studentEarns[studentName].paid += amount;
                });
            }

            // Calculate profit
            let totalProfit = 0;
            financeData?.forEach(c => totalProfit += parseFloat(c.ganancia_neta || 0));
            extraIncomeData?.forEach(e => totalProfit += parseFloat(e.ganancia_neta || 0));

            document.getElementById('finance-total-paid').innerText = totalPaid.toFixed(2) + '€';
            document.getElementById('finance-total-pending').innerText = totalPending.toFixed(2) + '€';
            document.getElementById('finance-total-profit').innerText = totalProfit.toFixed(2) + '€';

            const list = document.getElementById('finance-student-list');
            const sortedNames = Object.keys(studentEarns).sort((a, b) => (studentEarns[b].paid + studentEarns[b].pending) - (studentEarns[a].paid + studentEarns[a].pending));

            list.innerHTML = sortedNames.map(name => {
                const data = studentEarns[name];
                return `
                    <div class="bg-white p-4 rounded-xl border border-primary/5 shadow-sm flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full border border-primary/10 bg-cover bg-center" style="background-image: url('${data.avatar || 'https://images.unsplash.com/photo-1599566150163-29194dcaad36?w=100'}')"></div>
                            <div>
                                <p class="font-bold text-[#1b110e] text-sm">${name}</p>
                                <p class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">Acumulado</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-extrabold text-[#1b110e]">${(data.paid + data.pending).toFixed(2)}€</p>
                            <p class="text-[10px] ${data.pending > 0 ? 'text-primary' : 'text-green-600'} font-bold">
                                ${data.pending > 0 ? `Pendiente: ${data.pending.toFixed(2)}€` : 'Todo pagado'}
                            </p>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-center py-8 text-gray-400">Sin ingresos registrados</p>';
        }

        async function loadExtraIncome() {
            const { data: extras } = await _supabase
                .from('ingresos_extras')
                .select('*, alumnos(nombre)')
                .order('fecha', { ascending: false });

            const list = document.getElementById('extra-income-list');

            if (!extras || extras.length === 0) {
                list.innerHTML = `<div class="bg-white p-8 rounded-2xl text-center border border-dashed border-gray-200">
                    <p class="text-gray-400">No hay otros ingresos registrados.</p>
                </div>`;
                return;
            }

            list.innerHTML = extras.map(e => {
                const dateObj = new Date(e.fecha);
                const nombre = e.alumnos?.nombre || e.nombre_manual || 'Varios';
                return `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-primary/5 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-primary/5 flex flex-col items-center justify-center shrink-0">
                                <span class="text-[10px] font-bold text-primary uppercase">${dateObj.toLocaleDateString('es-ES', { month: 'short' })}</span>
                                <span class="text-lg font-bold text-[#1b110e] leading-none">${dateObj.getDate()}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-[#1b110e]">${nombre}</h3>
                                <p class="text-xs text-gray-500 font-medium">${e.concepto}</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between md:justify-end gap-4 border-t md:border-t-0 pt-3 md:pt-0">
                            <div class="text-right pr-4">
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Cantidad</p>
                                <p class="text-lg font-extrabold text-[#1b110e]">${e.cantidad}€</p>
                            </div>
                            
                            <div class="flex flex-col gap-1.5 min-w-[120px]">
                                <button onclick="openProfitModal('${e.id}', 'ingresos_extras', ${e.cantidad}, ${e.ganancia_neta || 'null'})" 
                                    class="h-9 px-4 rounded-xl font-bold text-[10px] transition-all border flex items-center justify-center gap-1.5 ${e.ganancia_neta !== null ? 'bg-green-50 border-green-200 text-green-700' : 'bg-gray-50 border-gray-100 text-gray-400 hover:text-primary hover:bg-primary/5'}">
                                    <span class="material-symbols-outlined text-[16px]">${e.ganancia_neta !== null ? 'task_alt' : 'wallet'}</span>
                                    ${e.ganancia_neta !== null ? 'Propio: ' + e.ganancia_neta + '€' : 'Me lo quedo'}
                                </button>
                                
                                <button onclick="deleteExtraIncome('${e.id}')" class="h-9 px-4 rounded-xl font-bold text-[10px] bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition-all flex items-center justify-center gap-1.5">
                                    <span class="material-symbols-outlined text-[16px]">delete</span>
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadClubs(searchQuery = '') {
            let query = _supabase
                .from('clubes')
                .select('*')
                .order('nombre');

            if (searchQuery) {
                query = query.ilike('nombre', `%${searchQuery}%`);
            }

            const { data: clubs } = await query;

            const list = document.getElementById('clubs-list');
            list.innerHTML = clubs?.map(c => `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center gap-4">
                    <div class="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center shrink-0">
                        <span class="material-symbols-outlined text-primary text-2xl">location_on</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-[#1b110e]">${c.nombre}</h3>
                        <p class="text-xs text-gray-400">${c.direccion || 'Sin dirección'}</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditClubModal('${c.id}')" class="p-2 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-600 hover:text-white transition-colors" title="Editar Club">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                        <button onclick="deleteClub('${c.id}', '${c.nombre}')" class="p-2 text-red-600 bg-red-50 rounded-lg hover:bg-red-600 hover:text-white transition-colors" title="Eliminar Club">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-center py-8 text-gray-400 col-span-full">No se encontraron clubs</p>';
        }

        // Modal Logic
        function openModal(id) {
            // Reset forms if it's adding
            if (id === 'add-student-modal' && !document.getElementById('edit-student-id').value) {
                document.getElementById('student-modal-title').innerText = 'Añadir Alumno';
                document.getElementById('new-student-name').value = '';
                document.getElementById('new-student-level').value = '';
                document.getElementById('new-student-phone').value = '';
            }
            if (id === 'add-club-modal' && !document.getElementById('edit-club-id').value) {
                document.getElementById('club-modal-title').innerText = 'Añadir Club';
                document.getElementById('new-club-name').value = '';
                document.getElementById('new-club-address').value = '';
            }
            document.getElementById(id).classList.remove('hidden');
        }
        function closeModal(id) {
            if (id === 'add-student-modal') document.getElementById('edit-student-id').value = '';
            if (id === 'add-club-modal') document.getElementById('edit-club-id').value = '';
            document.getElementById(id).classList.add('hidden');
        }

        async function openEditStudentModal(id) {
            const { data: student } = await _supabase.from('alumnos').select('*').eq('id', id).single();
            if (student) {
                document.getElementById('edit-student-id').value = student.id;
                document.getElementById('student-modal-title').innerText = 'Editar Alumno';
                document.getElementById('new-student-name').value = student.nombre;
                document.getElementById('new-student-level').value = student.nivel || '';
                document.getElementById('new-student-phone').value = student.telefono || '';
                openModal('add-student-modal');
            }
        }

        async function openEditClubModal(id) {
            const { data: club } = await _supabase.from('clubes').select('*').eq('id', id).single();
            if (club) {
                document.getElementById('edit-club-id').value = club.id;
                document.getElementById('club-modal-title').innerText = 'Editar Club';
                document.getElementById('new-club-name').value = club.nombre;
                document.getElementById('new-club-address').value = club.direccion || '';
                openModal('add-club-modal');
            }
        }

        async function openAddClassModal() {
            document.getElementById('edit-class-id').value = '';
            document.getElementById('class-modal-title').innerText = 'Programar Clase';

            const { data: students } = await _supabase.from('alumnos').select('id, nombre').order('nombre');
            const { data: clubs } = await _supabase.from('clubes').select('id, nombre').order('nombre');

            const selectStudent = document.getElementById('class-student-id');
            selectStudent.innerHTML = students.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');

            const selectClub = document.getElementById('class-club-id');
            selectClub.innerHTML = clubs.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');

            // Set default date to today
            document.getElementById('class-date').value = new Date().toLocaleDateString('en-CA');
            document.getElementById('class-price').value = '';
            document.getElementById('class-court').value = '';

            openModal('add-class-modal');
        }

        async function openEditClassModal(id) {
            const { data: cls } = await _supabase.from('clases').select('*').eq('id', id).single();
            if (!cls) return;

            const { data: students } = await _supabase.from('alumnos').select('id, nombre').order('nombre');
            const { data: clubs } = await _supabase.from('clubes').select('id, nombre').order('nombre');

            document.getElementById('edit-class-id').value = cls.id;
            document.getElementById('class-modal-title').innerText = 'Editar Clase';

            const selectStudent = document.getElementById('class-student-id');
            selectStudent.innerHTML = students.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
            selectStudent.value = cls.alumno_id;

            const selectClub = document.getElementById('class-club-id');
            selectClub.innerHTML = clubs.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            selectClub.value = cls.club_id;

            document.getElementById('class-date').value = cls.fecha;
            document.getElementById('class-start').value = cls.hora_inicio.substring(0, 5);
            document.getElementById('class-end').value = cls.hora_fin.substring(0, 5);
            document.getElementById('class-type').value = cls.tipo;
            document.getElementById('class-court').value = cls.pista || '';
            document.getElementById('class-price').value = cls.precio || '';

            openModal('add-class-modal');
        }

        async function saveStudent() {
            const id = document.getElementById('edit-student-id').value;
            const nombre = document.getElementById('new-student-name').value;
            const nivel = document.getElementById('new-student-level').value;
            const telefono = document.getElementById('new-student-phone').value;

            if (!nombre) return alert('Nombre es obligatorio');

            let result;
            if (id) {
                result = await _supabase.from('alumnos').update({ nombre, nivel, telefono }).eq('id', id);
            } else {
                result = await _supabase.from('alumnos').insert([{ nombre, nivel, telefono }]);
            }

            if (result.error) {
                alert('Error guardando alumno: ' + result.error.message);
            } else {
                closeModal('add-student-modal');
                if (state.currentPage === 'students') loadStudents();
                if (state.currentPage === 'dashboard') loadDashboard();
            }
        }

        async function saveClub() {
            const id = document.getElementById('edit-club-id').value;
            const nombre = document.getElementById('new-club-name').value;
            const direccion = document.getElementById('new-club-address').value;

            if (!nombre) return alert('Nombre del club es obligatorio');

            let result;
            if (id) {
                result = await _supabase.from('clubes').update({ nombre, direccion }).eq('id', id);
            } else {
                result = await _supabase.from('clubes').insert([{ nombre, direccion }]);
            }

            if (result.error) {
                alert('Error guardando club: ' + result.error.message);
            } else {
                closeModal('add-club-modal');
                if (state.currentPage === 'clubs') loadClubs();
            }
        }

        async function saveClass() {
            const id = document.getElementById('edit-class-id').value;
            const studentId = document.getElementById('class-student-id').value;
            const date = document.getElementById('class-date').value;
            const start = document.getElementById('class-start').value;
            const end = document.getElementById('class-end').value;
            const type = document.getElementById('class-type').value;
            const court = document.getElementById('class-court').value;
            const clubId = document.getElementById('class-club-id').value;
            const price = document.getElementById('class-price').value;

            if (!studentId || !date || !start || !end) return alert('Todos los campos son obligatorios');

            const classData = {
                alumno_id: studentId,
                fecha: date,
                hora_inicio: start,
                hora_fin: end,
                tipo: type,
                pista: court,
                club_id: clubId,
                precio: price ? parseFloat(price) : null
            };

            let error;
            if (id) {
                const result = await _supabase.from('clases').update(classData).eq('id', id);
                error = result.error;
            } else {
                const result = await _supabase.from('clases').insert([classData]);
                error = result.error;
            }

            if (error) {
                alert('Error guardando clase: ' + error.message);
            } else {
                closeModal('add-class-modal');
                if (state.currentPage === 'dashboard') loadDashboard();
                if (state.currentPage === 'calendar') loadCalendar();
                if (state.currentPage === 'payments') loadPayments();
                if (state.currentPage === 'finance') loadFinance();
            }
        }

        // FAB Logic
        document.getElementById('add-btn').onclick = () => {
            if (state.currentPage === 'students') {
                openModal('add-student-modal');
            } else if (state.currentPage === 'clubs') {
                openModal('add-club-modal');
            } else if (state.currentPage === 'dashboard' || state.currentPage === 'calendar' || state.currentPage === 'payments') {
                openAddClassModal();
            } else if (state.currentPage === 'extra-income') {
                openAddExtraIncomeModal();
            }
        };

        // Initial Load
        async function init() {
            const { data: alumnos } = await _supabase.from('alumnos').select('*').order('nombre');
            state.alumnos = alumnos || [];

            const { data: clubes } = await _supabase.from('clubes').select('*').order('nombre');
            state.clubes = clubes || [];

            loadDashboard();
        }

        init();

        // Search Listeners
        document.getElementById('student-search').addEventListener('input', (e) => {
            loadStudents(e.target.value);
        });

        document.getElementById('club-search').addEventListener('input', (e) => {
            loadClubs(e.target.value);
        });

        // Reminder Logic
        async function togglePaid(classId, currentStatus) {
            const { error } = await _supabase
                .from('clases')
                .update({ pagado: !currentStatus })
                .eq('id', classId);

            if (error) {
                alert('Error al actualizar el estado de pago');
            } else {
                if (state.currentPage === 'dashboard') loadDashboard();
                if (state.currentPage === 'payments') loadPayments();
                if (state.currentPage === 'calendar') loadCalendar();
                if (state.currentPage === 'finance') loadFinance();
            }
        }

        async function sendClassReminder(classId) {
            const { data: cls } = await _supabase
                .from('clases')
                .select('*, alumnos(nombre, telefono), clubes(nombre)')
                .eq('id', classId)
                .single();

            if (!cls || !cls.alumnos.telefono) return alert('No se encontró el alumno o su teléfono');

            const today = new Date().toLocaleDateString('en-CA');
            const isToday = cls.fecha === today;
            const dayText = isToday ? 'hoy' : 'mañana';
            const message = `Hola ${cls.alumnos.nombre}, te confirmo tu clase de tenis de ${dayText} a las ${cls.hora_inicio.substring(0, 5)} en ${cls.clubes?.nombre || 'el club'}. ¡Nos vemos! 🎾`;

            sendWhatsApp(cls.alumnos.telefono, message);

            // Mark as sent
            await _supabase.from('clases').update({ recordatorio_enviado: true }).eq('id', classId);

            // Refresh to update the list
            loadDashboard();
        }

        async function sendAllReminders() {
            const today = new Date().toLocaleDateString('en-CA');
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('en-CA');

            const { data: list } = await _supabase
                .from('clases')
                .select('id')
                .in('fecha', [today, tomorrowStr])
                .eq('recordatorio_enviado', false);

            if (!list || list.length === 0) return alert('No hay recordatorios pendientes para hoy o mañana.');

            if (confirm(`Se abrirán ${list.length} pestañas de WhatsApp Web. ¿Continuar?\nNota: Asegúrate de permitir las ventanas emergentes (pop-ups).`)) {
                for (let i = 0; i < list.length; i++) {
                    const item = list[i];
                    // Open with a slight delay between them to avoid browser blocking multiple tabs
                    setTimeout(async () => {
                        await sendClassReminder(item.id);
                    }, i * 1500);
                }
            }
        }

        // Utilities
        async function deleteStudent(id, name) {
            if (!confirm(`¿Estás seguro de que quieres eliminar al alumno ${name}? Esta acción no se puede deshacer y eliminará también su historial de clases.`)) return;

            // Delete classes first because of foreign key constraints
            const { error: classesError } = await _supabase
                .from('clases')
                .delete()
                .eq('alumno_id', id);

            if (classesError) {
                alert('Error al eliminar las clases del alumno: ' + classesError.message);
                return;
            }

            const { error: studentError } = await _supabase
                .from('alumnos')
                .delete()
                .eq('id', id);

            if (studentError) {
                alert('Error al eliminar el alumno: ' + studentError.message);
            } else {
                loadStudents();
                if (state.currentPage === 'dashboard') loadDashboard();
                if (state.currentPage === 'finance') loadFinance();
            }
        }

        async function deleteClub(id, name) {
            if (!confirm(`¿Estás seguro de que quieres eliminar el club ${name}? Esta acción desvinculará el club de todas las clases programadas.`)) return;

            // Set club_id to null in classes instead of deleting classes
            const { error: classesError } = await _supabase
                .from('clases')
                .update({ club_id: null })
                .eq('club_id', id);

            if (classesError) {
                alert('Error al desvincular clases del club: ' + classesError.message);
                return;
            }

            const { error: clubError } = await _supabase
                .from('clubes')
                .delete()
                .eq('id', id);

            if (clubError) {
                alert('Error al eliminar el club: ' + clubError.message);
            } else {
                loadClubs();
                if (state.currentPage === 'dashboard') loadDashboard();
                if (state.currentPage === 'calendar') loadCalendar();
            }
        }

        async function deleteClass(id) {
            if (!confirm('¿Estás seguro de que quieres cancelar esta clase?')) return;

            const { error } = await _supabase
                .from('clases')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Error al cancelar la clase');
            } else {
                if (state.currentPage === 'dashboard') loadDashboard();
                if (state.currentPage === 'calendar') loadCalendar();
                if (state.currentPage === 'finance') loadFinance();
                if (state.currentPage === 'payments') loadPayments();
            }
        }

        async function openAddExtraIncomeModal() {
            const { data: students } = await _supabase.from('alumnos').select('id, nombre').order('nombre');
            const select = document.getElementById('extra-student-id');
            select.innerHTML = '<option value="">-- Seleccionar Alumno --</option><option value="manual">Otro / Anotar a mano</option>' +
                students.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');

            document.getElementById('extra-manual-name').value = '';
            document.getElementById('extra-concept').value = '';
            document.getElementById('extra-amount').value = '';
            document.getElementById('extra-date').value = new Date().toLocaleDateString('en-CA');
            toggleManualName();
            openModal('add-extra-income-modal');
        }

        function toggleManualName() {
            const select = document.getElementById('extra-student-id');
            const container = document.getElementById('manual-name-container');
            if (select.value === 'manual') container.classList.remove('hidden');
            else container.classList.add('hidden');
        }

        async function saveExtraIncome() {
            const studentId = document.getElementById('extra-student-id').value;
            const manualName = document.getElementById('extra-manual-name').value;
            const concept = document.getElementById('extra-concept').value;
            const amount = document.getElementById('extra-amount').value;
            const date = document.getElementById('extra-date').value;

            if (!concept || !amount || !date) return alert('Concepto, cantidad y fecha son obligatorios');
            if (!studentId && !manualName) return alert('Debes seleccionar un alumno o anotar un nombre');

            const data = {
                concepto: concept,
                cantidad: parseFloat(amount),
                fecha: date
            };

            if (studentId === 'manual') data.nombre_manual = manualName;
            else if (studentId) data.alumno_id = studentId;

            const { error } = await _supabase.from('ingresos_extras').insert([data]);

            if (error) {
                alert('Error guardando el ingreso: ' + error.message);
            } else {
                closeModal('add-extra-income-modal');
                if (state.currentPage === 'extra-income') loadExtraIncome();
                if (state.currentPage === 'finance') loadFinance();
            }
        }

        async function deleteExtraIncome(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este ingreso?')) return;
            const { error } = await _supabase.from('ingresos_extras').delete().eq('id', id);
            if (error) alert('Error al eliminar');
            else loadExtraIncome();
        }

        // Profit Management
        let currentProfitItem = { id: null, table: null, total: 0 };

        function openProfitModal(id, table, total, currentProfit) {
            currentProfitItem = { id, table, total };
            document.getElementById('profit-total-amount').innerText = total.toFixed(2) + '€';
            document.getElementById('profit-kept-amount').value = currentProfit !== null ? currentProfit : total;
            openModal('profit-modal');
        }

        function keepAll() {
            document.getElementById('profit-kept-amount').value = currentProfitItem.total;
        }

        async function saveProfit() {
            const amount = parseFloat(document.getElementById('profit-kept-amount').value);
            if (isNaN(amount)) return alert('Introduce una cantidad válida');

            const { error } = await _supabase
                .from(currentProfitItem.table)
                .update({ ganancia_neta: amount })
                .eq('id', currentProfitItem.id);

            if (error) {
                alert('Error al guardar: ' + error.message);
            } else {
                closeModal('profit-modal');
                if (state.currentPage === 'payments') loadPayments();
                if (state.currentPage === 'extra-income') loadExtraIncome();
                if (state.currentPage === 'finance') loadFinance();
            }
        }

        function sendWhatsApp(phone, message = 'Hola! Te escribo desde Tennis Coach Pro.') {
            if (!phone) return alert('El alumno no tiene teléfono registrado');
            const cleanPhone = phone.replace(/\D/g, '');

            // Detect if mobile to use wa.me, otherwise use web.whatsapp.com to avoid app prompt
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const url = isMobile
                ? `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`
                : `https://web.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(message)}`;

            window.open(url, '_blank');
        }

        async function loadWeeklySchedule() {
            const { data, error } = await _supabase
                .from('plantilla_semanal')
                .select('*, alumnos(nombre), clubes(nombre)')
                .order('hora_inicio');

            if (error) return console.error(error);
            state.weeklySlots = data;

            // Clear all containers
            for (let i = 0; i <= 6; i++) {
                const container = document.getElementById(`weekly-slots-${i}`);
                if (container) container.innerHTML = '';
            }

            // Populate containers
            data.forEach(slot => {
                const container = document.getElementById(`weekly-slots-${slot.dia_semana}`);
                if (!container) return;

                const slotEl = document.createElement('div');
                slotEl.className = 'group relative p-3 rounded-xl border border-gray-100 bg-gray-50/50 hover:border-primary/20 transition-all';
                slotEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-1.5 mb-1">
                                <p class="text-xs font-black text-[#1b110e]">${slot.alumnos?.nombre || 'Consulting'}</p>
                                <span class="px-1.5 py-0.5 rounded text-[8px] font-bold uppercase ${slot.tipo === 'Particular' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'}">${slot.tipo}</span>
                            </div>
                            <p class="text-[10px] text-gray-400 font-bold">${slot.hora_inicio.substring(0, 5)} - ${slot.hora_fin.substring(0, 5)}</p>
                            <div class="flex items-center justify-between mt-1 gap-2">
                                <p class="text-[9px] text-primary/70 font-bold uppercase">${slot.clubes?.nombre || 'Sin Club'}</p>
                                <p class="text-[10px] font-black text-[#1b110e]">${slot.precio}€</p>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-all">
                            <button onclick="openEditWeeklySlotModal('${slot.id}')" class="p-1 text-blue-400 hover:text-blue-500">
                                <span class="material-symbols-outlined text-sm">edit</span>
                            </button>
                            <button onclick="deleteWeeklySlot('${slot.id}')" class="p-1 text-red-400 hover:text-red-500">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(slotEl);
            });
        }

        function openWeeklySlotModal(dayIndex) {
            document.getElementById('weekly-slot-id').value = '';
            document.getElementById('weekly-slot-modal-title').innerText = 'Añadir a Horario Fijo';
            document.getElementById('weekly-day-index').value = dayIndex;

            // Populate selects
            const studentSelect = document.getElementById('weekly-student-id');
            studentSelect.innerHTML = state.alumnos.map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');

            const clubSelect = document.getElementById('weekly-club-id');
            clubSelect.innerHTML = state.clubes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');

            openModal('weekly-slot-modal');
        }

        async function openEditWeeklySlotModal(id) {
            const slot = state.weeklySlots.find(s => s.id === id);
            if (!slot) return;

            document.getElementById('weekly-slot-id').value = slot.id;
            document.getElementById('weekly-slot-modal-title').innerText = 'Editar Horario Fijo';
            document.getElementById('weekly-day-index').value = slot.dia_semana;

            // Populate selects
            const studentSelect = document.getElementById('weekly-student-id');
            studentSelect.innerHTML = state.alumnos.map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');
            studentSelect.value = slot.alumno_id;

            const clubSelect = document.getElementById('weekly-club-id');
            clubSelect.innerHTML = state.clubes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            clubSelect.value = slot.club_id;

            document.getElementById('weekly-start').value = slot.hora_inicio.substring(0, 5);
            document.getElementById('weekly-end').value = slot.hora_fin.substring(0, 5);
            document.getElementById('weekly-type').value = slot.tipo;

            openModal('weekly-slot-modal');
        }

        async function saveWeeklySlot() {
            const id = document.getElementById('weekly-slot-id').value;
            const tipo = document.getElementById('weekly-type').value;
            const precio = (tipo === 'Particular') ? 15 : 11;

            const slotData = {
                dia_semana: parseInt(document.getElementById('weekly-day-index').value),
                alumno_id: document.getElementById('weekly-student-id').value,
                club_id: document.getElementById('weekly-club-id').value,
                hora_inicio: document.getElementById('weekly-start').value,
                hora_fin: document.getElementById('weekly-end').value,
                tipo: tipo,
                precio: precio
            };

            let error;
            if (id) {
                const result = await _supabase.from('plantilla_semanal').update(slotData).eq('id', id);
                error = result.error;
            } else {
                const result = await _supabase.from('plantilla_semanal').insert([slotData]);
                error = result.error;
            }

            if (error) {
                alert(error.message);
            } else {
                closeModal('weekly-slot-modal');
                loadWeeklySchedule();
            }
        }

        async function deleteWeeklySlot(id) {
            const slot = state.weeklySlots.find(s => s.id === id);
            if (!slot) return;

            if (!confirm('¿Eliminar este horario fijo?')) return;
            const { error } = await _supabase.from('plantilla_semanal').delete().eq('id', id);

            if (error) {
                alert(error.message);
            } else {
                loadWeeklySchedule();

                // Set info for optional future deletion
                document.getElementById('del-slot-day').value = slot.dia_semana;
                document.getElementById('del-slot-start').value = slot.hora_inicio;
                document.getElementById('del-slot-end').value = slot.hora_fin;
                document.getElementById('del-slot-date').value = new Date().toLocaleDateString('en-CA');

                openModal('delete-future-slot-modal');
            }
        }

        async function executeDeleteFutureSlot() {
            const day = document.getElementById('del-slot-day').value;
            const start = document.getElementById('del-slot-start').value;
            const end = document.getElementById('del-slot-end').value;
            const dateStr = document.getElementById('del-slot-date').value;

            if (!dateStr) return alert('Selecciona una fecha');

            const btn = document.getElementById('del-slot-confirm-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-spin material-symbols-outlined">sync</span> Borrando...';
            btn.disabled = true;

            // Generate dates for that specific day of week
            const datesToDelete = [];
            let tempDate = new Date(dateStr);
            const currentYear = tempDate.getFullYear();
            const endOfYear = new Date(currentYear, 11, 31);

            while (tempDate <= endOfYear) {
                // Supabase use 0-6 (Dom-Sab). JS tempDate.getDay() also 0-6.
                if (tempDate.getDay() === parseInt(day)) {
                    datesToDelete.push(tempDate.toLocaleDateString('en-CA'));
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            if (datesToDelete.length > 0) {
                const { error } = await _supabase
                    .from('clases')
                    .delete()
                    .in('fecha', datesToDelete)
                    .eq('hora_inicio', start)
                    .eq('hora_fin', end);

                if (error) {
                    alert('Error al borrar del calendario: ' + error.message);
                } else {
                    alert(`Se han borrado las clases de los próximos ${datesToDelete.length} días seleccionados.`);
                }
            }

            closeModal('delete-future-slot-modal');
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (state.currentPage === 'calendar') loadCalendar();
            if (state.currentPage === 'dashboard') loadDashboard();
        }

        function propagateWeeklySchedule() {
            document.getElementById('propagate-start-date').value = new Date().toLocaleDateString('en-CA');
            openModal('propagate-modal');
        }

        async function executePropagation() {
            const startDateStr = document.getElementById('propagate-start-date').value;
            if (!startDateStr) return alert('Selecciona una fecha');

            const btn = document.getElementById('propagate-confirm-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-spin material-symbols-outlined">sync</span> Propagando...';
            btn.disabled = true;

            const startDate = new Date(startDateStr);
            const currentYear = startDate.getFullYear();
            const endOfYear = new Date(currentYear, 11, 31);

            // Fetch latest template data
            const { data: template } = await _supabase.from('plantilla_semanal').select('*');
            if (!template || template.length === 0) {
                alert('No hay horarios definidos en la plantilla.');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            const classesToInsert = [];
            let tempDate = new Date(startDate);

            while (tempDate <= endOfYear) {
                const dayOfWeek = tempDate.getDay(); // 0(Dom) - 6(Sab)
                const slotsForDay = template.filter(s => s.dia_semana === dayOfWeek);

                slotsForDay.forEach(slot => {
                    classesToInsert.push({
                        alumno_id: slot.alumno_id,
                        club_id: slot.club_id,
                        fecha: tempDate.toLocaleDateString('en-CA'),
                        hora_inicio: slot.hora_inicio,
                        hora_fin: slot.hora_fin,
                        tipo: slot.tipo,
                        precio: slot.precio,
                        pista: slot.pista
                    });
                });

                tempDate.setDate(tempDate.getDate() + 1);
            }

            // Batch insert in chunks of 100
            const chunkSize = 100;
            let successCount = 0;
            for (let i = 0; i < classesToInsert.length; i += chunkSize) {
                const chunk = classesToInsert.slice(i, i + chunkSize);
                const { error } = await _supabase.from('clases').insert(chunk);
                if (error) {
                    console.error('Error insertando lote:', error);
                } else {
                    successCount += chunk.length;
                }
            }

            alert(`¡Éxito! Se han generado ${successCount} clases hasta el 31/12/${currentYear}.`);
            closeModal('propagate-modal');
            btn.innerHTML = originalText;
        }

        function openDeleteFutureModal() {
            document.getElementById('delete-future-date').value = new Date().toLocaleDateString('en-CA');
            openModal('delete-future-modal');
        }

        async function executeDeleteFuture() {
            const dateStr = document.getElementById('delete-future-date').value;
            if (!dateStr) return alert('Por favor, selecciona una fecha.');

            if (!confirm(`¿Estás seguro de que quieres borrar TODAS las clases a partir del ${dateStr}? Esta acción es irreversible.`)) return;

            const btn = document.getElementById('delete-future-confirm-btn');
            btn.innerHTML = '<span class="animate-spin material-symbols-outlined">sync</span> Borrando...';
            btn.disabled = true;

            const { error } = await _supabase
                .from('clases')
                .delete()
                .gte('fecha', dateStr);

            if (error) {
                alert('Error al borrar: ' + error.message);
            } else {
                alert('Clases futuras eliminadas correctamente.');
                closeModal('delete-future-modal');
                if (state.currentPage === 'calendar') loadCalendar();
                if (state.currentPage === 'dashboard') loadDashboard();
            }

            btn.innerHTML = 'Borrar Clases';
            btn.disabled = false;
        }

        function setFinanceMode(mode) {
            state.financeMode = mode;
            const btnWeek = document.getElementById('mode-week');
            const btnMonth = document.getElementById('mode-month');

            if (mode === 'week') {
                btnWeek.classList.add('bg-white', 'shadow-sm', 'text-primary');
                btnWeek.classList.remove('text-gray-500');
                btnMonth.classList.remove('bg-white', 'shadow-sm', 'text-primary');
                btnMonth.classList.add('text-gray-500');
            } else {
                btnMonth.classList.add('bg-white', 'shadow-sm', 'text-primary');
                btnMonth.classList.remove('text-gray-500');
                btnWeek.classList.remove('bg-white', 'shadow-sm', 'text-primary');
                btnWeek.classList.add('text-gray-500');
            }
            loadFinance();
        }

        function changeFinancePeriod(delta) {
            if (state.financeMode === 'week') {
                state.financeDate.setDate(state.financeDate.getDate() + (delta * 7));
            } else {
                state.financeDate.setMonth(state.financeDate.getMonth() + delta);
            }
            loadFinance();
        }


    </script>
</body>

</html>